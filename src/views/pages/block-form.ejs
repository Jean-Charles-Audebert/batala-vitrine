<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Batala Vitrine</title>
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-container">
    <div class="toolbar">
      <h1><%= title %></h1>
      <a href="/blocks" class="btn btn-secondary">
        <img src="/icons/cancel.svg" alt="" class="btn-icon">
        Annuler
      </a>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert-error"><%= error %></div>
    <% } %>

    <form method="POST" action="<%= formAction %>" class="form-block">
      <% const blockType = block ? block.type : null; %>
      <% const isHeader = blockType === 'header'; %>
      <% const isFooter = blockType === 'footer'; %>
      <% const isStructural = isHeader || isFooter; %>
      
      <!-- Type de bloc (masqué si édition d'un bloc structurel) -->
      <% if (!block || !isStructural) { %>
        <div class="form-group">
          <label for="type">Type de bloc *</label>
          <select 
            id="type" 
            name="type" 
            required
            <%= block && block.is_locked ? 'disabled' : '' %>
          >
            <option value="">-- Sélectionner un type --</option>
            <option value="header" <%= blockType === 'header' ? 'selected' : '' %>>Header</option>
            <option value="events" <%= blockType === 'events' ? 'selected' : '' %>>Événements</option>
            <option value="offers" <%= blockType === 'offers' ? 'selected' : '' %>>Offres</option>
            <option value="footer" <%= blockType === 'footer' ? 'selected' : '' %>>Footer</option>
            <option value="custom" <%= blockType === 'custom' ? 'selected' : '' %>>Personnalisé</option>
          </select>
          <small class="form-help">
            Le type détermine la structure et le comportement du bloc.
          </small>
        </div>
      <% } else { %>
        <!-- Type caché pour les blocs structurels -->
        <input type="hidden" name="type" value="<%= blockType %>">
        <div class="alert-info" style="margin-bottom: 1.5rem;">
          <strong>Type :</strong> <%= isHeader ? 'Header (en-tête)' : 'Footer (pied de page)' %>
        </div>
      <% } %>

      <!-- Titre du bloc (pour tous sauf header qui a header_title) -->
      <% if (!isHeader) { %>
        <div class="form-group">
          <label for="title">Titre *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            value="<%= block ? block.title || '' : '' %>" 
            required
            placeholder="Titre du bloc"
          >
        </div>
      <% } %>

      <!-- Champs spécifiques au HEADER -->
      <% if (isHeader) { %>
        <div class="form-group">
          <label for="header_title">Titre du site *</label>
          <input 
            type="text" 
            id="header_title" 
            name="header_title" 
            value="<%= block ? block.header_title || '' : '' %>" 
            required
            placeholder="Batala La Rochelle"
          >
          <small class="form-help">
            Le titre principal affiché dans le header.
          </small>
        </div>

        <div class="form-group">
          <label for="header_logo">Logo (URL ou chemin) *</label>
          <input 
            type="text" 
            id="header_logo" 
            name="header_logo" 
            value="<%= block ? block.header_logo || '' : '' %>" 
            placeholder="/assets/logo.svg ou /uploads/logo.png"
          >
          <small class="form-help">
            Chemin vers l'image du logo (relatif depuis /public/).
          </small>
          <% if (block && block.header_logo) { %>
            <div style="margin-top: 0.5rem;">
              <img src="<%= block.header_logo %>" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } %>
        </div>

        <div class="form-group">
          <label for="bg_image">Image de fond</label>
          <input 
            type="text" 
            id="bg_image" 
            name="bg_image" 
            value="<%= block ? block.bg_image || '' : '' %>" 
            placeholder="/assets/header-bg.jpg ou /uploads/bg.jpg"
          >
          <small class="form-help">
            Image de fond pour le header (optionnel).
          </small>
          <% if (block && block.bg_image) { %>
            <div style="margin-top: 0.5rem;">
              <img src="<%= block.bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } %>
        </div>
      <% } %>

      <!-- Slug (masqué pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="slug">Slug (URL) *</label>
          <input 
            type="text" 
            id="slug" 
            name="slug" 
            value="<%= block ? block.slug : '' %>" 
            required
            pattern="[a-z0-9-]+"
            placeholder="exemple-bloc"
            <%= block && block.is_locked ? 'readonly' : '' %>
          >
          <small class="form-help">
            Identifiant unique (minuscules, chiffres et tirets uniquement).
            <% if (block && block.is_locked) { %>
              <strong>Ce champ est verrouillé.</strong>
            <% } %>
          </small>
        </div>
      <% } else { %>
        <!-- Slug caché pour les blocs structurels -->
        <input type="hidden" name="slug" value="<%= block ? block.slug : '' %>">
      <% } %>

      <!-- Position (masquée pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="position">Position *</label>
          <input 
            type="number" 
            id="position" 
            name="position" 
            value="<%= block ? block.position : 999 %>" 
            required
            min="1"
          >
          <small class="form-help">
            Ordre d'affichage (1 = premier).
          </small>
        </div>
      <% } else { %>
        <!-- Position cachée pour les blocs structurels -->
        <input type="hidden" name="position" value="<%= block ? block.position : '' %>">
      <% } %>

      <% if (block && block.is_locked) { %>
        <div class="alert-info">
          <strong>ℹ️ Bloc système :</strong> Le type, le slug et la position sont gérés automatiquement.
        </div>
      <% } %>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <img src="/icons/save.svg" alt="" class="btn-icon">
          <%= block ? 'Mettre à jour' : 'Créer' %>
        </button>
        <a href="/blocks" class="btn btn-secondary">
          <img src="/icons/cancel.svg" alt="" class="btn-icon">
          Annuler
        </a>
      </div>
    </form>
  </div>

  <script>
    // Auto-génération du slug depuis le titre
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    const isEdit = <%= block ? 'true' : 'false' %>;
    const isLocked = <%= block && block.is_locked ? 'true' : 'false' %>;

    if (!isEdit && titleInput && slugInput) {
      titleInput.addEventListener('input', (e) => {
        const slug = e.target.value
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever les accents
          .replace(/[^a-z0-9\s-]/g, '') // Garder uniquement a-z, 0-9, espaces et tirets
          .trim()
          .replace(/\s+/g, '-') // Remplacer espaces par tirets
          .replace(/-+/g, '-'); // Éviter les tirets multiples
        slugInput.value = slug;
      });
    }

    // Empêcher la modification du slug si verrouillé
    if (isLocked && slugInput) {
      slugInput.addEventListener('keydown', (e) => {
        e.preventDefault();
      });
    }
  </script>
</body>
</html>
