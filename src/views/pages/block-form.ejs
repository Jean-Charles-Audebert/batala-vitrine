<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css', '/css/buttons.css']
  })
%>
  <div class="admin-container">
    <%
      const toolbarButtons = [{ href: '/blocks', class: 'btn-secondary', icon: 'cancel', label: 'Annuler' }];
      // Ajouter bouton "G√©rer les √©l√©ments" si √©dition d'un footer
      if (block && block.type === 'footer') {
        toolbarButtons.push({ href: `/blocks/${block.id}/footer-elements`, class: 'btn-primary', icon: 'list', label: 'G√©rer les √©l√©ments' });
      }
    %>
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons
      })
    %>

    <%- include('../partials/alerts') %>

    <form method="POST" action="<%= formAction %>" class="form-block">
      <% const blockType = block ? block.type : null; %>
      <% const isHeader = blockType === 'header'; %>
      <% const isFooter = blockType === 'footer'; %>
      <% const isStructural = isHeader || isFooter; %>
      
      <!-- Type de bloc (masqu√© si √©dition d'un bloc structurel) -->
      <% if (!block || !isStructural) { %>
        <div class="form-group">
          <label for="type">Type de bloc *</label>
          <select 
            id="type" 
            name="type" 
            required
            <%= block && block.is_locked ? 'disabled' : '' %>
          >
            <option value="">-- S√©lectionner un type --</option>
            <option value="header" <%= blockType === 'header' ? 'selected' : '' %>>Header</option>
            <option value="events" <%= blockType === 'events' ? 'selected' : '' %>>√âv√©nements</option>
            <option value="offers" <%= blockType === 'offers' ? 'selected' : '' %>>Offres</option>
            <option value="footer" <%= blockType === 'footer' ? 'selected' : '' %>>Footer</option>
            <option value="custom" <%= blockType === 'custom' ? 'selected' : '' %>>Personnalis√©</option>
          </select>
          <small class="form-help">
            Le type d√©termine la structure et le comportement du bloc.
          </small>
        </div>
      <% } else { %>
        <!-- Type cach√© pour les blocs structurels -->
        <input type="hidden" name="type" value="<%= blockType %>">
        <div class="alert-info" style="margin-bottom: 1.5rem;">
          <strong>Type :</strong> <%= isHeader ? 'Header (en-t√™te)' : 'Footer (pied de page)' %>
        </div>
      <% } %>

      <!-- Titre du bloc (pour tous sauf header qui a header_title) -->
      <% if (!isHeader) { %>
        <div class="form-group">
          <label for="title">Titre *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            value="<%= block ? block.title || '' : '' %>" 
            required
            placeholder="Titre du bloc"
          >
        </div>
      <% } %>

      <!-- Champs sp√©cifiques au HEADER -->
      <% if (isHeader) { %>
        <div class="form-group">
          <label for="header_title">Titre du site *</label>
          <input 
            type="text" 
            id="header_title" 
            name="header_title" 
            value="<%= block ? block.header_title || '' : '' %>" 
            required
            placeholder="Nom du site"
          >
          <small class="form-help">
            Le titre principal affich√© dans le header.
          </small>
        </div>

        <div class="form-group">
          <label for="header_logo">Logo (URL ou chemin) *</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="header_logo" 
              name="header_logo" 
              value="<%= block ? block.header_logo || '' : '' %>" 
              placeholder="/assets/logo.svg ou /uploads/logo.png"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="header_logo_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="header_logo"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('header_logo_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="header_logo_status">
            Entrez un chemin (ex: <code>/assets/logo.svg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
          </small>
          <% if (block && block.header_logo) { %>
            <div style="margin-top: 0.5rem;" id="header_logo_preview">
              <img src="<%= block.header_logo %>" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="header_logo_preview">
              <img src="" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } %>
        </div>

        <div class="form-group">
          <label for="bg_image">Image de fond</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="bg_image" 
              name="bg_image" 
              value="<%= block ? block.bg_image || '' : '' %>" 
              placeholder="/assets/header-bg.jpg ou /uploads/bg.jpg"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="bg_image_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="bg_image"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('bg_image_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="bg_image_status">
            Entrez un chemin (ex: <code>/assets/bg.jpg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
          </small>
          <% if (block && block.bg_image) { %>
            <div style="margin-top: 0.5rem;" id="bg_image_preview">
              <img src="<%= block.bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="bg_image_preview">
              <img src="" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } %>
        </div>

        <!-- Param√®tres globaux de la page (uniquement pour header) -->
        <% if (pageSettings) { %>
          <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
          
          <h2 style="margin-bottom: 2rem; color: #333; font-size: 1.5rem;">üé® Th√®me de la page</h2>
          
          <p style="margin-bottom: 2rem; padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px;">
            <strong>‚ÑπÔ∏è Information :</strong> Personnalisez l'apparence de votre site en d√©finissant les th√®mes pour chaque zone (Header, Contenu principal, Footer).
            <br><br>
            <a href="/" target="_blank" style="color: #1976D2; text-decoration: underline;">üëÅÔ∏è Aper√ßu du site dans un nouvel onglet</a>
          </p>
          
          <!-- SECTION 1: HEADER -->
          <h3 style="margin: 2rem 0 1rem 0; padding: 0.75rem; background: #f5f5f5; border-left: 4px solid #2196F3; color: #333; font-size: 1.25rem;">
            üìã Zone 1 : En-t√™te (Header)
          </h3>
          
          <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
            Personnalisez l'apparence de la zone d'en-t√™te du site (logo, titre principal).
          </p>

          <div class="form-group">
            <label for="header_bg_image">Image de fond du header</label>
            <input 
              type="text" 
              id="header_bg_image" 
              name="header_bg_image" 
              value="<%= pageSettings.header_bg_image || '' %>" 
              placeholder="/assets/header-bg.jpg"
            >
            <small class="form-help">Image affich√©e en arri√®re-plan du header.</small>
          </div>

          <div class="form-group">
            <label for="header_bg_color">Couleur de fond du header</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="color" 
                id="header_bg_color" 
                name="header_bg_color" 
                value="<%= pageSettings.header_bg_color || '#ffffff' %>"
                style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
              >
              <input 
                type="text" 
                value="<%= pageSettings.header_bg_color || '#ffffff' %>" 
                readonly
                style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
                id="header_bg_color_display"
              >
            </div>
            <small class="form-help">Couleur de fond si aucune image n'est d√©finie.</small>
          </div>

          <div class="form-group">
            <label for="header_title_font">Police du titre du header</label>
            <select id="header_title_font" name="header_title_font">
              <% const headerTitleFont = pageSettings.header_title_font || 'Arial, sans-serif'; %>
              <option value="Arial, sans-serif" <%= headerTitleFont === 'Arial, sans-serif' ? 'selected' : '' %>>Arial</option>
              <option value="'Helvetica Neue', Helvetica, sans-serif" <%= headerTitleFont === "'Helvetica Neue', Helvetica, sans-serif" ? 'selected' : '' %>>Helvetica</option>
              <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" <%= headerTitleFont === "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" ? 'selected' : '' %>>Segoe UI</option>
              <option value="Georgia, serif" <%= headerTitleFont === 'Georgia, serif' ? 'selected' : '' %>>Georgia (Serif)</option>
              <option value="'Times New Roman', Times, serif" <%= headerTitleFont === "'Times New Roman', Times, serif" ? 'selected' : '' %>>Times New Roman</option>
              <option value="Verdana, sans-serif" <%= headerTitleFont === 'Verdana, sans-serif' ? 'selected' : '' %>>Verdana</option>
            </select>
            <small class="form-help">Police utilis√©e pour le titre du site dans le header.</small>
          </div>

          <div class="form-group">
            <label for="header_title_color">Couleur du titre du header</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="color" 
                id="header_title_color" 
                name="header_title_color" 
                value="<%= pageSettings.header_title_color || '#333333' %>"
                style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
              >
              <input 
                type="text" 
                value="<%= pageSettings.header_title_color || '#333333' %>" 
                readonly
                style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
                id="header_title_color_display"
              >
            </div>
            <small class="form-help">Couleur du titre du site.</small>
          </div>

          <!-- SECTION 2: MAIN CONTENT -->
          <h3 style="margin: 2rem 0 1rem 0; padding: 0.75rem; background: #f5f5f5; border-left: 4px solid #4CAF50; color: #333; font-size: 1.25rem;">
            üìÑ Zone 2 : Contenu principal (Main)
          </h3>
          
          <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
            Personnalisez l'apparence de la zone de contenu principal (tous les blocs entre le header et le footer).
          </p>

          <div class="form-group">
            <label for="main_bg_image">Image de fond du contenu principal</label>
            <input 
              type="text" 
              id="main_bg_image" 
              name="main_bg_image" 
              value="<%= pageSettings.main_bg_image || '' %>" 
              placeholder="/assets/main-bg.jpg"
            >
            <small class="form-help">Image affich√©e en arri√®re-plan du contenu principal.</small>
          </div>

          <div class="form-group">
            <label for="main_bg_color">Couleur de fond du contenu principal</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="color" 
                id="main_bg_color" 
                name="main_bg_color" 
                value="<%= pageSettings.main_bg_color || '#f5f5f5' %>"
                style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
              >
              <input 
                type="text" 
                value="<%= pageSettings.main_bg_color || '#f5f5f5' %>" 
                readonly
                style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
                id="main_bg_color_display"
              >
            </div>
            <small class="form-help">Couleur de fond visible derri√®re les blocs transparents.</small>
          </div>

          <div class="form-group">
            <label for="main_title_font">Police des titres du contenu</label>
            <select id="main_title_font" name="main_title_font">
              <% const mainTitleFont = pageSettings.main_title_font || 'Arial, sans-serif'; %>
              <option value="Arial, sans-serif" <%= mainTitleFont === 'Arial, sans-serif' ? 'selected' : '' %>>Arial</option>
              <option value="'Helvetica Neue', Helvetica, sans-serif" <%= mainTitleFont === "'Helvetica Neue', Helvetica, sans-serif" ? 'selected' : '' %>>Helvetica</option>
              <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" <%= mainTitleFont === "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif" ? 'selected' : '' %>>Segoe UI</option>
              <option value="Georgia, serif" <%= mainTitleFont === 'Georgia, serif' ? 'selected' : '' %>>Georgia (Serif)</option>
              <option value="'Times New Roman', Times, serif" <%= mainTitleFont === "'Times New Roman', Times, serif" ? 'selected' : '' %>>Times New Roman</option>
              <option value="Verdana, sans-serif" <%= mainTitleFont === 'Verdana, sans-serif' ? 'selected' : '' %>>Verdana</option>
            </select>
            <small class="form-help">Police des titres des blocs de contenu.</small>
          </div>

          <div class="form-group">
            <label for="main_title_color">Couleur des titres du contenu</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="color" 
                id="main_title_color" 
                name="main_title_color" 
                value="<%= pageSettings.main_title_color || '#333333' %>"
                style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
              >
              <input 
                type="text" 
                value="<%= pageSettings.main_title_color || '#333333' %>" 
                readonly
                style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
                id="main_title_color_display"
              >
            </div>
            <small class="form-help">Couleur des titres de section (si non personnalis√©s au niveau du bloc).</small>
          </div>

          <!-- SECTION 3: FOOTER -->
          <h3 style="margin: 2rem 0 1rem 0; padding: 0.75rem; background: #f5f5f5; border-left: 4px solid #FF9800; color: #333; font-size: 1.25rem;">
            üîñ Zone 3 : Pied de page (Footer)
          </h3>
          
          <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
            Personnalisez l'apparence de la zone de pied de page (informations, contact, liens sociaux).
          </p>

          <div class="form-group">
            <label for="footer_bg_image">Image de fond du footer</label>
            <input 
              type="text" 
              id="footer_bg_image" 
              name="footer_bg_image" 
              value="<%= pageSettings.footer_bg_image || '' %>" 
              placeholder="/assets/footer-bg.jpg"
            >
            <small class="form-help">Image affich√©e en arri√®re-plan du footer.</small>
          </div>

          <div class="form-group">
            <label for="footer_bg_color">Couleur de fond du footer</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="color" 
                id="footer_bg_color" 
                name="footer_bg_color" 
                value="<%= pageSettings.footer_bg_color || '#2c3e50' %>"
                style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
              >
              <input 
                type="text" 
                value="<%= pageSettings.footer_bg_color || '#2c3e50' %>" 
                readonly
                style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
                id="footer_bg_color_display"
              >
            </div>
            <small class="form-help">‚ö†Ô∏è Le fond du footer doit √™tre fonc√© (les ic√¥nes des r√©seaux sociaux sont blanches).</small>
          </div>

          <div class="form-group">
            <label for="footer_text_color">Couleur du texte du footer</label>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <input 
                type="color" 
                id="footer_text_color" 
                name="footer_text_color" 
                value="<%= pageSettings.footer_text_color || '#ecf0f1' %>"
                style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
              >
              <input 
                type="text" 
                value="<%= pageSettings.footer_text_color || '#ecf0f1' %>" 
                readonly
                style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
                id="footer_text_color_display"
              >
            </div>
            <small class="form-help">Couleur du texte dans le footer (souvent clair).</small>
          </div>
        <% } %>
      <% } %>

      <!-- Slug (masqu√© pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="slug">Slug (URL) *</label>
          <input 
            type="text" 
            id="slug" 
            name="slug" 
            value="<%= block ? block.slug : '' %>" 
            required
            pattern="[a-z0-9-]+"
            placeholder="exemple-bloc"
            <%= block && block.is_locked ? 'readonly' : '' %>
          >
          <small class="form-help">
            Identifiant unique (minuscules, chiffres et tirets uniquement).
            <% if (block && block.is_locked) { %>
              <strong>Ce champ est verrouill√©.</strong>
            <% } %>
          </small>
        </div>
      <% } else { %>
        <!-- Slug cach√© pour les blocs structurels -->
        <input type="hidden" name="slug" value="<%= block ? block.slug : '' %>">
      <% } %>

      <!-- Position (masqu√©e pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="position">Position *</label>
          <input 
            type="number" 
            id="position" 
            name="position" 
            value="<%= block ? block.position : 2 %>" 
            required
            min="1"
          >
          <small class="form-help">
            Ordre d'affichage (1 = premier).
          </small>
        </div>
      <% } else { %>
        <!-- Position cach√©e pour les blocs structurels -->
        <input type="hidden" name="position" value="<%= block ? block.position : '' %>">
      <% } %>


      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <img src="/icons/save.svg" alt="" class="icon">
          <%= block ? 'Mettre √† jour' : 'Cr√©er' %>
        </button>
        <a href="/blocks" class="btn btn-secondary">
          <img src="/icons/cancel.svg" alt="" class="icon">
          Annuler
        </a>
      </div>
    </form>
  </div>

  <% if (block) { %>
    <script>
      // Passer les donn√©es au script (√©vite de m√©langer logique et rendu)
      const slugEl = document.getElementById('slug');
      if (slugEl) {
        slugEl.dataset.isEdit = '<%= block ? 'true' : 'false' %>';
        slugEl.dataset.isLocked = '<%= block && block.is_locked ? 'true' : 'false' %>';
      }
    </script>
  <% } %>

  <% if (block && block.type === 'header' && pageSettings) { %>
    <script>
      // Synchroniser les inputs color avec les displays textuels (3 zones)
      const colorInputs = [
        'header_bg_color', 'header_title_color',
        'main_bg_color', 'main_title_color',
        'footer_bg_color', 'footer_text_color'
      ];
      colorInputs.forEach(id => {
        const input = document.getElementById(id);
        const display = document.getElementById(id + '_display');
        if (input && display) {
          input.addEventListener('input', (e) => {
            display.value = e.target.value.toUpperCase();
          });
        }
      });

      // Validation : le footer doit avoir un fond fonc√© (pour les ic√¥nes blanches)
      const footerBgInput = document.getElementById('footer_bg_color');
      if (footerBgInput) {
        footerBgInput.addEventListener('input', (e) => {
          const hex = e.target.value;
          // Calculer la luminosit√©
          const rgb = parseInt(hex.slice(1), 16);
          const r = (rgb >> 16) & 0xff;
          const g = (rgb >> 8) & 0xff;
          const b = (rgb >> 0) & 0xff;
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
          
          // Si trop clair (luminance > 0.5), forcer une couleur sombre
          if (luminance > 0.5) {
            e.target.value = '#2c3e50';
            document.getElementById('footer_bg_color_display').value = '#2C3E50';
            alert('Le fond du footer doit √™tre fonc√© pour que les ic√¥nes blanches soient visibles.');
          }
        });
      }
    </script>
  <% } %>

<%-
  include('../partials/footer', {
    scripts: ['/js/block-form.js', '/js/image-upload.js']
  })
%>
