<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css']
  })
%>
  <div class="admin-container">
    <%
      const toolbarButtons = [{ href: '/blocks', class: 'btn-secondary', icon: 'cancel', label: 'Annuler' }];
      // Ajouter bouton "Gérer les éléments" si édition d'un footer
      if (block && block.type === 'footer') {
        toolbarButtons.push({ href: `/blocks/${block.id}/footer-elements`, class: 'btn-primary', icon: 'list', label: 'Gérer les éléments' });
      }
    %>
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons
      })
    %>

    <%- include('../partials/alerts') %>

    <form method="POST" action="<%= formAction %>" class="form-block">
      <% const blockType = block ? block.type : null; %>
      <% const isHeader = blockType === 'header'; %>
      <% const isFooter = blockType === 'footer'; %>
      <% const isStructural = isHeader || isFooter; %>
      
      <!-- Type de bloc (masqué si édition d'un bloc structurel) -->
      <% if (!block || !isStructural) { %>
        <div class="form-group">
          <label for="type">Type de bloc *</label>
          <select 
            id="type" 
            name="type" 
            required
            <%= block && block.is_locked ? 'disabled' : '' %>
          >
            <option value="">-- Sélectionner un type --</option>
            <option value="header" <%= blockType === 'header' ? 'selected' : '' %>>Header</option>
            <option value="events" <%= blockType === 'events' ? 'selected' : '' %>>Événements</option>
            <option value="offers" <%= blockType === 'offers' ? 'selected' : '' %>>Offres</option>
            <option value="footer" <%= blockType === 'footer' ? 'selected' : '' %>>Footer</option>
            <option value="custom" <%= blockType === 'custom' ? 'selected' : '' %>>Personnalisé</option>
          </select>
          <small class="form-help">
            Le type détermine la structure et le comportement du bloc.
          </small>
        </div>
      <% } else { %>
        <!-- Type caché pour les blocs structurels -->
        <input type="hidden" name="type" value="<%= blockType %>">
        <div class="alert-info" style="margin-bottom: 1.5rem;">
          <strong>Type :</strong> <%= isHeader ? 'Header (en-tête)' : 'Footer (pied de page)' %>
        </div>
      <% } %>

      <!-- Titre du bloc (pour tous sauf header qui a header_title) -->
      <% if (!isHeader) { %>
        <div class="form-group">
          <label for="title">Titre *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            value="<%= block ? block.title || '' : '' %>" 
            required
            placeholder="Titre du bloc"
          >
        </div>
      <% } %>

      <!-- Champs spécifiques au HEADER -->
      <% if (isHeader) { %>
        <div class="form-group">
          <label for="header_title">Titre du site *</label>
          <input 
            type="text" 
            id="header_title" 
            name="header_title" 
            value="<%= block ? block.header_title || '' : '' %>" 
            required
            placeholder="Nom du site"
          >
          <small class="form-help">
            Le titre principal affiché dans le header.
          </small>
        </div>

        <div class="form-group">
          <label for="header_logo">Logo (URL ou chemin) *</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="header_logo" 
              name="header_logo" 
              value="<%= block ? block.header_logo || '' : '' %>" 
              placeholder="/assets/logo.svg ou /uploads/logo.png"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="header_logo_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="header_logo"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('header_logo_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="btn-icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="header_logo_status">
            Entrez un chemin (ex: <code>/assets/logo.svg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
          </small>
          <% if (block && block.header_logo) { %>
            <div style="margin-top: 0.5rem;" id="header_logo_preview">
              <img src="<%= block.header_logo %>" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="header_logo_preview">
              <img src="" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } %>
        </div>

        <div class="form-group">
          <label for="bg_image">Image de fond</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="bg_image" 
              name="bg_image" 
              value="<%= block ? block.bg_image || '' : '' %>" 
              placeholder="/assets/header-bg.jpg ou /uploads/bg.jpg"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="bg_image_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="bg_image"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('bg_image_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="btn-icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="bg_image_status">
            Entrez un chemin (ex: <code>/assets/bg.jpg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
          </small>
          <% if (block && block.bg_image) { %>
            <div style="margin-top: 0.5rem;" id="bg_image_preview">
              <img src="<%= block.bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="bg_image_preview">
              <img src="" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } %>
        </div>
      <% } %>

      <!-- Slug (masqué pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="slug">Slug (URL) *</label>
          <input 
            type="text" 
            id="slug" 
            name="slug" 
            value="<%= block ? block.slug : '' %>" 
            required
            pattern="[a-z0-9-]+"
            placeholder="exemple-bloc"
            <%= block && block.is_locked ? 'readonly' : '' %>
          >
          <small class="form-help">
            Identifiant unique (minuscules, chiffres et tirets uniquement).
            <% if (block && block.is_locked) { %>
              <strong>Ce champ est verrouillé.</strong>
            <% } %>
          </small>
        </div>
      <% } else { %>
        <!-- Slug caché pour les blocs structurels -->
        <input type="hidden" name="slug" value="<%= block ? block.slug : '' %>">
      <% } %>

      <!-- Position (masquée pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="position">Position *</label>
          <input 
            type="number" 
            id="position" 
            name="position" 
            value="<%= block ? block.position : 999 %>" 
            required
            min="1"
          >
          <small class="form-help">
            Ordre d'affichage (1 = premier).
          </small>
        </div>
      <% } else { %>
        <!-- Position cachée pour les blocs structurels -->
        <input type="hidden" name="position" value="<%= block ? block.position : '' %>">
      <% } %>

      <% if (block && block.is_locked) { %>
        <div class="alert-info">
          <strong>ℹ️ Bloc système :</strong> Le type, le slug et la position sont gérés automatiquement.
        </div>
      <% } %>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <img src="/icons/save.svg" alt="" class="btn-icon">
          <%= block ? 'Mettre à jour' : 'Créer' %>
        </button>
        <a href="/blocks" class="btn btn-secondary">
          <img src="/icons/cancel.svg" alt="" class="btn-icon">
          Annuler
        </a>
      </div>
    </form>
  </div>

  <% if (block) { %>
    <script>
      // Passer les données au script (évite de mélanger logique et rendu)
      const slugEl = document.getElementById('slug');
      if (slugEl) {
        slugEl.dataset.isEdit = '<%= block ? 'true' : 'false' %>';
        slugEl.dataset.isLocked = '<%= block && block.is_locked ? 'true' : 'false' %>';
      }
    </script>
  <% } %>

<%-
  include('../partials/footer', {
    scripts: ['/js/block-form.js', '/js/image-upload.js']
  })
%>
