<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css', '/css/buttons.css']
  })
%>
  <div class="admin-container">
    <%
      const toolbarButtons = [{ href: '/blocks', class: 'btn-secondary', icon: 'cancel', label: 'Annuler' }];
      // Ajouter bouton "G√©rer les √©l√©ments" si √©dition d'un footer
      if (block && block.type === 'footer') {
        toolbarButtons.push({ href: `/blocks/${block.id}/footer-elements`, class: 'btn-primary', icon: 'list', label: 'G√©rer les √©l√©ments' });
      }
    %>
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons
      })
    %>

    <%- include('../partials/alerts') %>

    <form method="POST" action="<%= formAction %>" class="form-block">
      <% const blockType = block ? block.type : null; %>
      <% const isHeader = blockType === 'header'; %>
      <% const isFooter = blockType === 'footer'; %>
      <% const isStructural = isHeader || isFooter; %>
      
      <!-- Type de bloc (masqu√© si √©dition d'un bloc structurel) -->
      <% if (!block || !isStructural) { %>
        <div class="form-group">
          <label for="type">Type de bloc *</label>
          <select 
            id="type" 
            name="type" 
            required
            <%= block && block.is_locked ? 'disabled' : '' %>
          >
            <option value="">-- S√©lectionner un type --</option>
            <option value="header" <%= blockType === 'header' ? 'selected' : '' %>>Header</option>
            <option value="events" <%= blockType === 'events' ? 'selected' : '' %>>√âv√©nements</option>
            <option value="offers" <%= blockType === 'offers' ? 'selected' : '' %>>Offres</option>
            <option value="footer" <%= blockType === 'footer' ? 'selected' : '' %>>Footer</option>
            <option value="custom" <%= blockType === 'custom' ? 'selected' : '' %>>Personnalis√©</option>
          </select>
          <small class="form-help">
            Le type d√©termine la structure et le comportement du bloc.
          </small>
        </div>
      <% } else { %>
        <!-- Type cach√© pour les blocs structurels -->
        <input type="hidden" name="type" value="<%= blockType %>">
        <div class="alert-info" style="margin-bottom: 1.5rem;">
          <strong>Type :</strong> <%= isHeader ? 'Header (en-t√™te)' : 'Footer (pied de page)' %>
        </div>
      <% } %>

      <!-- Titre du bloc (pour tous sauf header qui a header_title) -->
      <% if (!isHeader) { %>
        <div class="form-group">
          <label for="title">Titre *</label>
          <input 
            type="text" 
            id="title" 
            name="title" 
            value="<%= block ? block.title || '' : '' %>" 
            required
            placeholder="Titre du bloc"
          >
        </div>
      <% } %>

      <!-- Champs sp√©cifiques au HEADER -->
      <% if (isHeader) { %>
        <div class="form-group">
          <label for="header_title">Titre du site</label>
          <input 
            type="text" 
            id="header_title" 
            name="header_title" 
            value="<%= block ? block.header_title || '' : '' %>" 
            placeholder="Nom du site"
          >
          <small class="form-help">
            Le titre principal affich√© dans le header. <strong>Facultatif</strong> : si votre logo comporte d√©j√† le nom du site, vous pouvez laisser ce champ vide.
          </small>
        </div>

        <div class="form-group">
          <label for="header_logo">Logo (URL ou chemin) *</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="header_logo" 
              name="header_logo" 
              value="<%= block ? block.header_logo || '' : '' %>" 
              placeholder="/assets/logo.svg ou /uploads/logo.png"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="header_logo_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="header_logo"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('header_logo_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="header_logo_status">
            Entrez un chemin (ex: <code>/assets/logo.svg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
          </small>
          <% if (block && block.header_logo) { %>
            <div style="margin-top: 0.5rem;" id="header_logo_preview">
              <img src="<%= block.header_logo %>" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="header_logo_preview">
              <img src="" alt="Logo" style="max-width: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            </div>
          <% } %>
        </div>

        <div class="form-group">
          <label for="bg_image">Image de fond</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="bg_image" 
              name="bg_image" 
              value="<%= block ? block.bg_image || '' : '' %>" 
              placeholder="/assets/header-bg.jpg ou /uploads/bg.jpg"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="bg_image_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="bg_image"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('bg_image_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="bg_image_status">
            Entrez un chemin (ex: <code>/assets/bg.jpg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
          </small>
          <% if (block && block.bg_image) { %>
            <div style="margin-top: 0.5rem;" id="bg_image_preview">
              <img src="<%= block.bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="bg_image_preview">
              <img src="" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } %>
        </div>

        <!-- Param√®tres globaux de la page (uniquement pour header) -->
        <% if (pageSettings) { %>
          <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
          
          <h2 style="margin-bottom: 2rem; color: #333; font-size: 1.5rem;">üé® Th√®me de la page</h2>
          
          <p style="margin-bottom: 2rem; padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px;">
            <strong>‚ÑπÔ∏è Information :</strong> Personnalisez l'apparence de votre site en d√©finissant les th√®mes pour chaque zone (Header, Contenu principal, Footer).
            <br><br>
            <a href="/" target="_blank" style="color: #1976D2; text-decoration: underline;">üëÅÔ∏è Aper√ßu du site dans un nouvel onglet</a>
          </p>
          
          <!-- SECTION 1: HEADER -->
          <h3 style="margin: 2rem 0 1rem 0; padding: 0.75rem; background: #f5f5f5; border-left: 4px solid #2196F3; color: #333; font-size: 1.25rem;">
            üìã Zone 1 : En-t√™te (Header)
          </h3>
          
          <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
            Personnalisez l'apparence de la zone d'en-t√™te du site (logo, titre principal).
          </p>

          <div class="form-group">
            <label for="header_bg_image">Image de fond du header</label>
            <input 
              type="text" 
              id="header_bg_image" 
              name="header_bg_image" 
              value="<%= pageSettings.header_bg_image || '' %>" 
              placeholder="/assets/header-bg.jpg"
            >
            <small class="form-help">Image affich√©e en arri√®re-plan du header.</small>
          </div>

          <%- include('../components/color-picker', {
            name: 'header_bg_color',
            label: 'Couleur de fond du header',
            value: pageSettings.header_bg_color || '#ffffff',
            helpText: 'Couleur de fond si aucune image n\'est d√©finie.'
          }) %>

          <div class="form-group">
            <label for="title_font_id">Police des titres (h1-h6) *</label>
            <select id="title_font_id" name="title_font_id" required>
              <% if (fonts && fonts.length > 0) { %>
                <% fonts.forEach(font => { %>
                  <option value="<%= font.id %>" <%= (pageSettings.title_font_id || 1) == font.id ? 'selected' : '' %>>
                    <%= font.name %><% if (font.source !== 'system') { %> (<%= font.source === 'google' ? 'Google Fonts' : 'Upload' %>)<% } %>
                  </option>
                <% }); %>
              <% } %>
            </select>
            <small class="form-help">
              Police utilis√©e pour <strong>TOUS les titres du site</strong> (header, blocs, cartes).<br>
              üìö <a href="/fonts" style="color: #1976d2; font-weight: bold;">G√©rer ma biblioth√®que de polices ‚Üí</a>
            </small>
          </div>

          <%- include('../components/color-picker', {
            name: 'header_title_color',
            label: 'Couleur du titre du header',
            value: pageSettings.header_title_color || '#333333',
            helpText: 'Couleur du titre du site.'
          }) %>

          <!-- SECTION 2: MAIN CONTENT -->
          <h3 style="margin: 2rem 0 1rem 0; padding: 0.75rem; background: #f5f5f5; border-left: 4px solid #4CAF50; color: #333; font-size: 1.25rem;">
            üìÑ Zone 2 : Contenu principal (Main)
          </h3>
          
          <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
            Personnalisez l'apparence de la zone de contenu principal (tous les blocs entre le header et le footer).
          </p>

          <div class="form-group">
            <label for="main_bg_image">Image de fond du contenu principal</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input 
                type="text" 
                id="main_bg_image" 
                name="main_bg_image" 
                value="<%= pageSettings.main_bg_image || '' %>" 
                placeholder="/assets/main-bg.jpg ou /uploads/bg.gif"
                style="flex: 1;"
              >
              <input 
                type="file" 
                id="main_bg_image_upload" 
                accept="image/*"
                style="display: none;"
                data-target-field="main_bg_image"
              >
              <button 
                type="button" 
                class="btn btn-secondary btn-sm"
                onclick="document.getElementById('main_bg_image_upload').click()"
                title="Uploader une image"
              >
                <img src="/icons/image.svg" alt="" class="icon">
                Choisir
              </button>
            </div>
            <small class="form-help" id="main_bg_image_status">
              Entrez un chemin (ex: <code>/assets/bg.jpg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
            </small>
            <% if (pageSettings.main_bg_image) { %>
              <div style="margin-top: 0.5rem;" id="main_bg_image_preview">
                <img src="<%= pageSettings.main_bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            <% } else { %>
              <div style="margin-top: 0.5rem; display: none;" id="main_bg_image_preview">
                <img src="" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            <% } %>
          </div>

          <%- include('../components/color-picker', {
            name: 'main_bg_color',
            label: 'Couleur de fond du contenu principal',
            value: pageSettings.main_bg_color || '#f5f5f5',
            helpText: 'Couleur de fond visible derri√®re les blocs transparents.'
          }) %>

          <%- include('../components/color-picker', {
            name: 'main_title_color',
            label: 'Couleur des titres du contenu',
            value: pageSettings.main_title_color || '#333333',
            helpText: 'Couleur des titres de section (si non personnalis√©s au niveau du bloc).'
          }) %>

          <!-- SECTION 3: FOOTER -->
          <h3 style="margin: 2rem 0 1rem 0; padding: 0.75rem; background: #f5f5f5; border-left: 4px solid #FF9800; color: #333; font-size: 1.25rem;">
            üîñ Zone 3 : Pied de page (Footer)
          </h3>
          
          <p style="margin-bottom: 1rem; color: #666; font-size: 0.95rem;">
            Personnalisez l'apparence de la zone de pied de page (informations, contact, liens sociaux).
          </p>

          <div class="form-group">
            <label for="footer_bg_image">Image de fond du footer</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input 
                type="text" 
                id="footer_bg_image" 
                name="footer_bg_image" 
                value="<%= pageSettings.footer_bg_image || '' %>" 
                placeholder="/assets/footer-bg.jpg ou /uploads/bg.gif"
                style="flex: 1;"
              >
              <input 
                type="file" 
                id="footer_bg_image_upload" 
                accept="image/*"
                style="display: none;"
                data-target-field="footer_bg_image"
              >
              <button 
                type="button" 
                class="btn btn-secondary btn-sm"
                onclick="document.getElementById('footer_bg_image_upload').click()"
                title="Uploader une image"
              >
                <img src="/icons/image.svg" alt="" class="icon">
                Choisir
              </button>
            </div>
            <small class="form-help" id="footer_bg_image_status">
              Entrez un chemin (ex: <code>/assets/bg.jpg</code>) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
            </small>
            <% if (pageSettings.footer_bg_image) { %>
              <div style="margin-top: 0.5rem;" id="footer_bg_image_preview">
                <img src="<%= pageSettings.footer_bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            <% } else { %>
              <div style="margin-top: 0.5rem; display: none;" id="footer_bg_image_preview">
                <img src="" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            <% } %>
          </div>

          <%- include('../components/color-picker', {
            name: 'footer_bg_color',
            label: 'Couleur de fond du footer',
            value: pageSettings.footer_bg_color || '#2c3e50',
            helpText: '‚ö†Ô∏è Le fond du footer doit √™tre fonc√© (les ic√¥nes des r√©seaux sociaux sont blanches).'
          }) %>

          <%- include('../components/color-picker', {
            name: 'footer_text_color',
            label: 'Couleur du texte du footer',
            value: pageSettings.footer_text_color || '#ecf0f1',
            helpText: 'Couleur du texte dans le footer (souvent clair).'
          }) %>
        <% } %>
      <% } %>

      <!-- Personnalisation du th√®me du bloc (pour les blocs non-structurels) -->
      <% if (!isStructural) { %>
        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
        
        <h2 style="margin-bottom: 2rem; color: #333; font-size: 1.5rem;">üé® Apparence du bloc</h2>
        
        <p style="margin-bottom: 1.5rem; padding: 1rem; background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 4px;">
          <strong>‚ÑπÔ∏è Information :</strong> Personnalisez l'apparence de ce bloc. Si vous ne d√©finissez pas de couleurs, le bloc utilisera les param√®tres globaux d√©finis dans la page Header.
        </p>

        <div class="form-group">
          <label>
            <input 
              type="checkbox" 
              id="is_transparent" 
              name="is_transparent" 
              <%= block && block.is_transparent ? 'checked' : '' %>
            >
            Fond transparent
          </label>
          <small class="form-help">
            Si activ√©, le fond de ce bloc sera transparent et laissera appara√Ætre l'arri√®re-plan de la page.
          </small>
        </div>

        <div class="form-group">
          <label for="bg_image_block">Image de fond du bloc</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input 
              type="text" 
              id="bg_image_block" 
              name="bg_image" 
              value="<%= block ? block.bg_image || '' : '' %>" 
              placeholder="/assets/bg.jpg ou /uploads/bg.png"
              style="flex: 1;"
            >
            <input 
              type="file" 
              id="bg_image_block_upload" 
              accept="image/*"
              style="display: none;"
              data-target-field="bg_image_block"
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('bg_image_block_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="icon">
              Choisir
            </button>
          </div>
          <small class="form-help" id="bg_image_block_status">
            Image affich√©e en arri√®re-plan de ce bloc sp√©cifiquement.
          </small>
          <% if (block && block.bg_image) { %>
            <div style="margin-top: 0.5rem;" id="bg_image_block_preview">
              <img src="<%= block.bg_image %>" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } else { %>
            <div style="margin-top: 0.5rem; display: none;" id="bg_image_block_preview">
              <img src="" alt="Fond" style="max-width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          <% } %>
        </div>

        <div class="form-group">
          <label for="block_bg_color">Couleur de fond du bloc</label>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <input 
              type="color" 
              id="block_bg_color" 
              name="block_bg_color" 
              value="<%= block && block.bg_color ? block.bg_color : '#ffffff' %>"
              style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
            >
            <input 
              type="text" 
              value="<%= block && block.bg_color ? block.bg_color : '' %>" 
              placeholder="Non d√©fini (utilise la couleur globale)"
              style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
              id="block_bg_color_display"
              readonly
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('block_bg_color').value=''; document.getElementById('block_bg_color_display').value='';"
              title="R√©initialiser (utiliser le th√®me global)"
            >
              ‚úï R√©init
            </button>
          </div>
          <small class="form-help">
            Couleur de fond de ce bloc (surcharge le th√®me global). Cliquez sur "R√©init" pour utiliser la couleur globale.
          </small>
        </div>

        <div class="form-group">
          <label for="block_title_color">Couleur du titre du bloc</label>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <input 
              type="color" 
              id="block_title_color" 
              name="block_title_color" 
              value="<%= block && block.title_color ? block.title_color : '#333333' %>"
              style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;"
            >
            <input 
              type="text" 
              value="<%= block && block.title_color ? block.title_color : '' %>" 
              placeholder="Non d√©fini (utilise la couleur globale)"
              style="flex: 1; background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem; border-radius: 4px; font-family: monospace;"
              id="block_title_color_display"
              readonly
            >
            <button 
              type="button" 
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('block_title_color').value=''; document.getElementById('block_title_color_display').value='';"
              title="R√©initialiser (utiliser le th√®me global)"
            >
              ‚úï R√©init
            </button>
          </div>
          <small class="form-help">
            Couleur du titre de ce bloc (surcharge le th√®me global). Cliquez sur "R√©init" pour utiliser la couleur globale.
          </small>
        </div>

        <script>
          // Synchroniser les color pickers du bloc
          (function() {
            const bgColorInput = document.getElementById('block_bg_color');
            const bgColorDisplay = document.getElementById('block_bg_color_display');
            const titleColorInput = document.getElementById('block_title_color');
            const titleColorDisplay = document.getElementById('block_title_color_display');
            
            if (bgColorInput && bgColorDisplay) {
              bgColorInput.addEventListener('input', function() {
                bgColorDisplay.value = this.value.toUpperCase();
              });
            }
            
            if (titleColorInput && titleColorDisplay) {
              titleColorInput.addEventListener('input', function() {
                titleColorDisplay.value = this.value.toUpperCase();
              });
            }
          })();
        </script>
      <% } %>

      <!-- Slug (masqu√© pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="slug">Slug (URL) *</label>
          <input 
            type="text" 
            id="slug" 
            name="slug" 
            value="<%= block ? block.slug : '' %>" 
            required
            pattern="[a-z0-9-]+"
            placeholder="exemple-bloc"
            <%= block && block.is_locked ? 'readonly' : '' %>
          >
          <small class="form-help">
            Identifiant unique (minuscules, chiffres et tirets uniquement).
            <% if (block && block.is_locked) { %>
              <strong>Ce champ est verrouill√©.</strong>
            <% } %>
          </small>
        </div>
      <% } else { %>
        <!-- Slug cach√© pour les blocs structurels -->
        <input type="hidden" name="slug" value="<%= block ? block.slug : '' %>">
      <% } %>

      <!-- Position (masqu√©e pour les blocs structurels) -->
      <% if (!isStructural) { %>
        <div class="form-group">
          <label for="position">Position *</label>
          <input 
            type="number" 
            id="position" 
            name="position" 
            value="<%= block ? block.position : 2 %>" 
            required
            min="1"
          >
          <small class="form-help">
            Ordre d'affichage (1 = premier).
          </small>
        </div>
      <% } else { %>
        <!-- Position cach√©e pour les blocs structurels -->
        <input type="hidden" name="position" value="<%= block ? block.position : '' %>">
      <% } %>

      <!-- SECTION 4: GESTION DES BLOCS (uniquement pour header) -->
      <% if (isHeader && pageSettings && allBlocks) { %>
        <hr style="margin: 2rem 0; border: 1px solid #e0e0e0;">
        
        <h2 style="margin-bottom: 2rem; color: #333; font-size: 1.5rem;">üì¶ Gestion des blocs</h2>
        
        <p style="margin-bottom: 1.5rem; color: #666;">
          Les blocs d√©finissent la structure de votre page. Vous pouvez r√©organiser, modifier ou supprimer les blocs existants.
        </p>

        <div style="margin-bottom: 1.5rem;">
          <%- include('../components/icon-button', {
            type: 'a',
            href: '/blocks/new',
            className: 'btn btn-primary',
            icon: 'plus',
            text: 'Nouveau bloc',
            ariaLabel: 'Cr√©er un nouveau bloc'
          }) %>
        </div>

        <% if (allBlocks && allBlocks.length > 0) { %>
          <table role="table" aria-label="Liste des blocs du site" style="width: 100%; margin-bottom: 2rem;">
            <thead>
              <tr>
                <th scope="col">Position</th>
                <th scope="col">Type</th>
                <th scope="col">Titre</th>
                <th scope="col">Slug</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody id="blocks-list-embedded">
              <% allBlocks.forEach(blockItem => { %>
                <tr data-block-id="<%= blockItem.id %>" data-position="<%= blockItem.position %>" data-block-type="<%= blockItem.type %>">
                  <td class="block-position">
                    <span class="position-value"><%= blockItem.position %></span>
                    <% if (blockItem.type !== 'header' && blockItem.type !== 'footer') { %>
                      <%- include('../components/position-controls', { itemTitle: blockItem.title, itemType: 'le bloc' }) %>
                    <% } else { %>
                      <span class="text-muted" style="font-size: 0.85rem;">
                        <%= blockItem.type === 'header' ? 'üîù Toujours en premier' : 'üîö Toujours en dernier' %>
                      </span>
                    <% } %>
                  </td>
                  <td>
                    <span class="badge badge-type-<%= blockItem.type %>">
                      <%= blockItem.type %>
                    </span>
                  </td>
                  <td><%= blockItem.title %></td>
                  <td><code><%= blockItem.slug %></code></td>
                  <td>
                    <div class="actions" role="group" aria-label="Actions pour le bloc <%= blockItem.title %>">
                      <% if (blockItem.type === 'events' || blockItem.type === 'offers') { %>
                        <%- include('../components/icon-button', {
                          type: 'a',
                          href: `/blocks/${blockItem.id}/cards`,
                          className: 'btn btn-secondary btn-sm',
                          icon: 'image',
                          ariaLabel: `G√©rer les cartes du bloc ${blockItem.title}`
                        }) %>
                      <% } %>
                      <% if (blockItem.type === 'footer') { %>
                        <%- include('../components/icon-button', {
                          type: 'a',
                          href: `/blocks/${blockItem.id}/footer-elements`,
                          className: 'btn btn-secondary btn-sm',
                          icon: 'list',
                          ariaLabel: `G√©rer les √©l√©ments du footer`
                        }) %>
                      <% } %>
                      <%- include('../components/icon-button', {
                        type: 'a',
                        href: `/blocks/${blockItem.id}/edit`,
                        className: 'btn btn-secondary btn-sm',
                        icon: 'edit',
                        ariaLabel: `Modifier le bloc ${blockItem.title}`
                      }) %>
                      <% if (!blockItem.is_locked) { %>
                        <form 
                          method="POST" 
                          action="/blocks/<%= blockItem.id %>/delete" 
                          style="display: inline;"
                          onsubmit="return confirm('√ätes-vous s√ªr de vouloir supprimer ce bloc ?');"
                          aria-label="Formulaire de suppression"
                        >
                          <%- include('../components/icon-button', {
                            type: 'submit',
                            className: 'btn btn-danger btn-sm',
                            icon: 'trash',
                            ariaLabel: `Supprimer le bloc ${blockItem.title}`
                          }) %>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        <% } else { %>
          <div class="empty-state">
            <p>Aucun bloc pour le moment.</p>
          </div>
        <% } %>
      <% } %>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <img src="/icons/save.svg" alt="" class="icon">
          <%= block ? 'Mettre √† jour' : 'Cr√©er' %>
        </button>
        <a href="<%= isHeader ? '/' : '/blocks' %>" class="btn btn-secondary">
          <img src="/icons/cancel.svg" alt="" class="icon">
          <%= isHeader ? 'Retour √† l\'accueil' : 'Annuler' %>
        </a>
      </div>
    </form>
  </div>

  <% if (block) { %>
    <script>
      // Passer les donn√©es au script (√©vite de m√©langer logique et rendu)
      const slugEl = document.getElementById('slug');
      if (slugEl) {
        slugEl.dataset.isEdit = '<%= block ? 'true' : 'false' %>';
        slugEl.dataset.isLocked = '<%= block && block.is_locked ? 'true' : 'false' %>';
      }
    </script>
  <% } %>

  <% if (block && block.type === 'header' && pageSettings) { %>
    <script>
      // Synchroniser les inputs color avec les displays textuels (3 zones)
      const colorInputs = [
        'header_bg_color', 'header_title_color',
        'main_bg_color', 'main_title_color',
        'footer_bg_color', 'footer_text_color'
      ];
      colorInputs.forEach(id => {
        const input = document.getElementById(id);
        const display = document.getElementById(id + '_display');
        if (input && display) {
          input.addEventListener('input', (e) => {
            display.value = e.target.value.toUpperCase();
          });
        }
      });

      // Validation : le footer doit avoir un fond fonc√© (pour les ic√¥nes blanches)
      const footerBgInput = document.getElementById('footer_bg_color');
      if (footerBgInput) {
        footerBgInput.addEventListener('input', (e) => {
          const hex = e.target.value;
          // Calculer la luminosit√©
          const rgb = parseInt(hex.slice(1), 16);
          const r = (rgb >> 16) & 0xff;
          const g = (rgb >> 8) & 0xff;
          const b = (rgb >> 0) & 0xff;
          const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
          
          // Si trop clair (luminance > 0.5), forcer une couleur sombre
          if (luminance > 0.5) {
            e.target.value = '#2c3e50';
            document.getElementById('footer_bg_color_display').value = '#2C3E50';
            alert('Le fond du footer doit √™tre fonc√© pour que les ic√¥nes blanches soient visibles.');
          }
        });
      }

      // R√©ordonnancement des blocs (gestion int√©gr√©e)
      const blocksList = document.getElementById('blocks-list-embedded');
      if (blocksList) {
        const rows = Array.from(blocksList.querySelectorAll('tr'));

        // Fonction pour √©changer deux lignes
        function swapRows(index1, index2) {
          if (index2 < 0 || index2 >= rows.length) return;
          
          const row1 = rows[index1];
          const row2 = rows[index2];
          
          // Emp√™cher de d√©placer ou √©changer avec le header ou le footer
          const type1 = row1.getAttribute('data-block-type');
          const type2 = row2.getAttribute('data-block-type');
          const isFixed1 = type1 === 'header' || type1 === 'footer';
          const isFixed2 = type2 === 'header' || type2 === 'footer';
          
          if (isFixed1 || isFixed2) {
            console.log('Le header et le footer ne peuvent pas √™tre d√©plac√©s');
            return;
          }
          
          if (index1 < index2) {
            row2.parentNode.insertBefore(row1, row2.nextSibling);
          } else {
            row1.parentNode.insertBefore(row2, row1);
          }
          
          // Inverser dans le tableau local
          [rows[index1], rows[index2]] = [rows[index2], rows[index1]];
          
          // Mettre √† jour les positions visuelles
          updatePositions();
          
          // Envoyer au serveur
          saveOrder();
        }

        // Mettre √† jour les num√©ros de position affich√©s
        function updatePositions() {
          rows.forEach((row, index) => {
            const positionSpan = row.querySelector('.position-value');
            if (positionSpan) {
              positionSpan.textContent = index + 1;
            }
            row.setAttribute('data-position', index + 1);
          });
        }

        // Enregistrer l'ordre sur le serveur
        function saveOrder() {
          const order = rows
            .filter(row => {
              const type = row.getAttribute('data-block-type');
              return type !== 'header' && type !== 'footer';
            })
            .map((row, index) => ({
              id: parseInt(row.getAttribute('data-block-id'), 10),
              position: index + 1
            }));

          fetch('/api/blocks/reorder', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order })
          })
          .then(response => response.json())
          .then(data => {
            if (!data.success) {
              console.error('Erreur lors de la sauvegarde:', data.error);
              alert('Erreur lors de la sauvegarde de l\'ordre');
            }
          })
          .catch(error => {
            console.error('Erreur r√©seau:', error);
            alert('Erreur r√©seau lors de la sauvegarde');
          });
        }

        // Attacher les √©v√©nements aux boutons
        rows.forEach((row, index) => {
          const btnUp = row.querySelector('.btn-move-up');
          const btnDown = row.querySelector('.btn-move-down');

          if (btnUp) {
            btnUp.addEventListener('click', () => swapRows(index, index - 1));
          }

          if (btnDown) {
            btnDown.addEventListener('click', () => swapRows(index, index + 1));
          }
        });
      }
    </script>
  <% } %>

<%-
  include('../partials/footer', {
    scripts: ['/js/block-form.js', '/js/image-upload.js']
  })
%>
