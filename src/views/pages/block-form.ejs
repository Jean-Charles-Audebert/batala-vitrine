<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Batala Vitrine</title>
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-container">
    <div class="toolbar">
      <h1><%= title %></h1>
      <a href="/blocks" class="btn btn-secondary">
        <img src="/icons/cancel.svg" alt="" class="btn-icon">
        Annuler
      </a>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert-error"><%= error %></div>
    <% } %>

    <form method="POST" action="<%= formAction %>" class="form-block">
      <div class="form-group">
        <label for="type">Type de bloc *</label>
        <select 
          id="type" 
          name="type" 
          required
          <%= block && block.is_locked ? 'disabled' : '' %>
        >
          <option value="">-- Sélectionner un type --</option>
          <option value="header" <%= block && block.type === 'header' ? 'selected' : '' %>>Header</option>
          <option value="events" <%= block && block.type === 'events' ? 'selected' : '' %>>Événements</option>
          <option value="offers" <%= block && block.type === 'offers' ? 'selected' : '' %>>Offres</option>
          <option value="footer" <%= block && block.type === 'footer' ? 'selected' : '' %>>Footer</option>
          <option value="custom" <%= block && block.type === 'custom' ? 'selected' : '' %>>Personnalisé</option>
        </select>
        <small class="form-help">
          Le type détermine la structure et le comportement du bloc.
        </small>
      </div>

      <div class="form-group">
        <label for="title">Titre *</label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          value="<%= block ? block.title || '' : '' %>" 
          required
          placeholder="Titre du bloc"
        >
      </div>

      <div class="form-group">
        <label for="slug">Slug (URL) *</label>
        <input 
          type="text" 
          id="slug" 
          name="slug" 
          value="<%= block ? block.slug : '' %>" 
          required
          pattern="[a-z0-9-]+"
          placeholder="exemple-bloc"
          <%= block && block.is_locked ? 'readonly' : '' %>
        >
        <small class="form-help">
          Identifiant unique (minuscules, chiffres et tirets uniquement).
          <% if (block && block.is_locked) { %>
            <strong>Ce champ est verrouillé.</strong>
          <% } %>
        </small>
      </div>

      <div class="form-group">
        <label for="position">Position *</label>
        <input 
          type="number" 
          id="position" 
          name="position" 
          value="<%= block ? block.position : 999 %>" 
          required
          min="1"
        >
        <small class="form-help">
          Ordre d'affichage (1 = premier).
        </small>
      </div>

      <% if (block && block.is_locked) { %>
        <div class="alert-error">
          <strong>⚠️ Bloc verrouillé :</strong> Certains champs ne peuvent pas être modifiés.
        </div>
      <% } %>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <img src="/icons/save.svg" alt="" class="btn-icon">
          <%= block ? 'Mettre à jour' : 'Créer' %>
        </button>
        <a href="/blocks" class="btn btn-secondary">
          <img src="/icons/cancel.svg" alt="" class="btn-icon">
          Annuler
        </a>
      </div>
    </form>
  </div>

  <script>
    // Auto-génération du slug depuis le titre
    const titleInput = document.getElementById('title');
    const slugInput = document.getElementById('slug');
    const isEdit = <%= block ? 'true' : 'false' %>;
    const isLocked = <%= block && block.is_locked ? 'true' : 'false' %>;

    if (!isEdit && titleInput && slugInput) {
      titleInput.addEventListener('input', (e) => {
        const slug = e.target.value
          .toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever les accents
          .replace(/[^a-z0-9\s-]/g, '') // Garder uniquement a-z, 0-9, espaces et tirets
          .trim()
          .replace(/\s+/g, '-') // Remplacer espaces par tirets
          .replace(/-+/g, '-'); // Éviter les tirets multiples
        slugInput.value = slug;
      });
    }

    // Empêcher la modification du slug si verrouillé
    if (isLocked && slugInput) {
      slugInput.addEventListener('keydown', (e) => {
        e.preventDefault();
      });
    }
  </script>
</body>
</html>
