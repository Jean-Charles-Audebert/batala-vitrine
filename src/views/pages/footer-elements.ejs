<%
  // Réorganiser les éléments par type
  const aboutElement = elements.find(el => el.type === 'text');
  const contactElement = elements.find(el => el.type === 'contact');
  const socialElements = elements.filter(el => el.type === 'social');
  const linkElements = elements.filter(el => el.type === 'link');
  
  // Parser les contenus JSON
  const aboutData = aboutElement ? (typeof aboutElement.content === 'string' ? JSON.parse(aboutElement.content) : aboutElement.content) : null;
  const contactData = contactElement ? (typeof contactElement.content === 'string' ? JSON.parse(contactElement.content) : contactElement.content) : null;
%>

<%- include('../partials/head', {
  title,
  stylesheets: ['/css/common.css', '/css/admin.css']
}) %>

<%- include('../partials/alerts', { success, error }) %>

<div class="container">
  <%- include('../partials/admin-toolbar', {
    title: `Éléments du footer : ${block.title}`,
    toolbarButtons: [
      { href: '/', class: 'btn btn-secondary', icon: '←', label: 'Retour à l\'accueil' }
    ]
  }) %>

  <!-- Section À propos -->
  <section class="admin-section">
    <div class="section-header">
      <h2>À propos</h2>
      <% if (aboutElement) { %>
        <a 
          href="/blocks/<%= block.id %>/footer-elements/<%= aboutElement.id %>/edit" 
          class="btn btn-secondary"
          aria-label="Modifier la section À propos"
        >
          <img src="/icons/edit.svg" alt="" role="presentation" class="icon" />
          Modifier
        </a>
      <% } else { %>
        <a 
          href="/blocks/<%= block.id %>/footer-elements/new?type=text" 
          class="btn btn-primary"
          aria-label="Créer la section À propos"
        >
          <img src="/icons/plus.svg" alt="" role="presentation" class="icon" />
          Créer
        </a>
      <% } %>
    </div>
    <div class="section-content">
      <% if (aboutData && aboutData.about_content) { %>
        <p><%= aboutData.about_content %></p>
      <% } else { %>
        <p class="text-muted">Aucune description. Créez la section pour ajouter du contenu.</p>
      <% } %>
    </div>
  </section>

  <!-- Section Contact -->
  <section class="admin-section">
    <div class="section-header">
      <h2>Contact</h2>
      <% if (contactElement) { %>
        <a 
          href="/blocks/<%= block.id %>/footer-elements/<%= contactElement.id %>/edit" 
          class="btn btn-secondary"
          aria-label="Modifier les coordonnées de contact"
        >
          <img src="/icons/edit.svg" alt="" role="presentation" class="icon" />
          Modifier
        </a>
      <% } else { %>
        <a 
          href="/blocks/<%= block.id %>/footer-elements/new?type=contact" 
          class="btn btn-primary"
          aria-label="Créer les coordonnées de contact"
        >
          <img src="/icons/plus.svg" alt="" role="presentation" class="icon" />
          Créer
        </a>
      <% } %>
    </div>
    <div class="section-content">
      <% if (contactData) { %>
        <dl class="contact-details">
          <% if (contactData.phone) { %>
            <dt>Téléphone :</dt>
            <dd><%= contactData.phone %></dd>
          <% } %>
          <% if (contactData.email) { %>
            <dt>Email :</dt>
            <dd><%= contactData.email %></dd>
          <% } %>
          <% if (contactData.address) { %>
            <dt>Adresse :</dt>
            <dd><%= contactData.address %></dd>
          <% } %>
        </dl>
      <% } else { %>
        <p class="text-muted">Aucune coordonnée. Créez la section pour ajouter vos informations.</p>
      <% } %>
    </div>
  </section>

  <!-- Section Réseaux sociaux -->
  <section class="admin-section">
    <div class="section-header">
      <h2>Réseaux sociaux</h2>
      <a 
        href="/blocks/<%= block.id %>/footer-elements/new?type=social" 
        class="btn btn-primary"
        aria-label="Ajouter un réseau social"
      >
        <img src="/icons/plus.svg" alt="" role="presentation" class="icon" />
        Ajouter
      </a>
    </div>
    <div class="section-content">
      <% if (socialElements.length > 0) { %>
        <ul class="social-list">
          <% socialElements.forEach(social => { 
            const socialData = typeof social.content === 'string' ? JSON.parse(social.content) : social.content;
            const links = socialData.links || [];
          %>
            <% links.forEach(link => { %>
              <li class="social-item">
                <div class="social-info">
                  <strong><%= link.network || link.platform %></strong>
                  <a href="<%= link.url %>" target="_blank" rel="noopener"><%= link.url %></a>
                </div>
                <div class="social-actions" role="toolbar">
                  <a 
                    href="/blocks/<%= block.id %>/footer-elements/<%= social.id %>/edit" 
                    class="btn-icon"
                    aria-label="Modifier <%= link.network || link.platform %>"
                  >
                    <img src="/icons/edit.svg" alt="" role="presentation" class="icon" />
                  </a>
                  <form 
                    action="/blocks/<%= block.id %>/footer-elements/<%= social.id %>/delete" 
                    method="POST" 
                    style="display:inline"
                    onsubmit="return confirm('Supprimer ce réseau social ?')"
                  >
                    <button 
                      type="submit" 
                      class="btn-icon btn-danger"
                      aria-label="Supprimer <%= link.network || link.platform %>"
                    >
                      <img src="/icons/trash.svg" alt="" role="presentation" class="icon" />
                    </button>
                  </form>
                </div>
              </li>
            <% }) %>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucun réseau social configuré. Ajoutez-en un pour commencer.</p>
      <% } %>
    </div>
  </section>

  <!-- Section Liens externes -->
  <section class="admin-section">
    <div class="section-header">
      <h2>Liens externes</h2>
      <a 
        href="/blocks/<%= block.id %>/footer-elements/new?type=link" 
        class="btn btn-primary"
        aria-label="Ajouter un lien externe"
      >
        <img src="/icons/plus.svg" alt="" role="presentation" class="icon" />
        Ajouter
      </a>
    </div>
    <div class="section-content">
      <% if (linkElements.length > 0) { %>
        <ul class="link-list">
          <% linkElements.forEach(linkEl => { 
            const linkData = typeof linkEl.content === 'string' ? JSON.parse(linkEl.content) : linkEl.content;
          %>
            <li class="link-item">
              <div class="link-info">
                <strong><%= linkData.label || linkData.title || 'Lien' %></strong>
                <a href="<%= linkData.url %>" target="_blank" rel="noopener"><%= linkData.url %></a>
              </div>
              <div class="link-actions" role="toolbar">
                <a 
                  href="/blocks/<%= block.id %>/footer-elements/<%= linkEl.id %>/edit" 
                  class="btn-icon"
                  aria-label="Modifier <%= linkData.label || 'ce lien' %>"
                >
                  <img src="/icons/edit.svg" alt="" role="presentation" class="icon" />
                </a>
                <form 
                  action="/blocks/<%= block.id %>/footer-elements/<%= linkEl.id %>/delete" 
                  method="POST" 
                  style="display:inline"
                  onsubmit="return confirm('Supprimer ce lien ?')"
                >
                  <button 
                    type="submit" 
                    class="btn-icon btn-danger"
                    aria-label="Supprimer <%= linkData.label || 'ce lien' %>"
                  >
                    <img src="/icons/trash.svg" alt="" role="presentation" class="icon" />
                  </button>
                </form>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted">Aucun lien externe. Ajoutez-en un pour commencer.</p>
      <% } %>
    </div>
  </section>
</div>

<%- include('../partials/footer', { scripts: [] }) %>
