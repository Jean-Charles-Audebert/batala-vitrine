<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Batala Vitrine</title>
  <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
  <div class="admin-container">
    <div class="toolbar">
      <h1><%= title %></h1>
      <a href="/blocks/<%= block.id %>/cards" class="btn btn-secondary">
        <img src="/icons/cancel.svg" alt="" class="btn-icon">
        Annuler
      </a>
    </div>

    <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert-error"><%= error %></div>
    <% } %>

    <form method="POST" action="<%= formAction %>" class="form-card">
      <div class="form-group">
        <label for="title">Titre de la carte *</label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          value="<%= card ? card.title : '' %>" 
          required
          placeholder="Titre de la carte"
        >
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea 
          id="description" 
          name="description" 
          rows="5"
          placeholder="Description détaillée de la carte"
        ><%= card ? card.description || '' : '' %></textarea>
      </div>

      <div class="form-group">
        <label for="media_path">Chemin de l'image</label>
        <input 
          type="text" 
          id="media_path" 
          name="media_path" 
          value="<%= card ? card.media_path || '' : '' %>" 
          placeholder="/uploads/image.jpg ou /assets/placeholder-1.svg"
        >
        <small class="form-help">
          Chemin relatif depuis /public/ ou URL complète.
          Pour uploader une image, utilisez le bouton ci-dessous.
        </small>
      </div>

      <!-- Preview de l'image -->
      <% if (card && card.media_path) { %>
        <div class="form-group">
          <label>Aperçu de l'image actuelle</label>
          <div class="image-preview">
            <img src="<%= card.media_path %>" alt="<%= card.title %>" style="max-width: 300px; border-radius: 8px;">
          </div>
        </div>
      <% } %>

      <!-- Upload d'image -->
      <div class="form-group">
        <label for="image_upload">Uploader une nouvelle image</label>
        <input 
          type="file" 
          id="image_upload" 
          accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
          onchange="handleImageUpload(event)"
        >
        <small id="upload_status" class="form-help">
          Formats acceptés : JPG, PNG, WebP, GIF (max 5 MB)
        </small>
      </div>

      <% if (block.type === 'events') { %>
        <div class="form-group">
          <label for="event_date">Date de l'événement</label>
          <input 
            type="date" 
            id="event_date" 
            name="event_date" 
            value="<%= card && card.event_date ? new Date(card.event_date).toISOString().split('T')[0] : '' %>"
          >
          <small class="form-help">
            Date de l'événement pour les cartes du bloc "Événements".
          </small>
        </div>
      <% } %>

      <div class="form-group">
        <label for="position">Position *</label>
        <input 
          type="number" 
          id="position" 
          name="position" 
          value="<%= card ? card.position : 999 %>" 
          required
          min="1"
        >
        <small class="form-help">
          Ordre d'affichage (1 = premier).
        </small>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <img src="/icons/save.svg" alt="" class="btn-icon">
          <%= card ? 'Mettre à jour' : 'Créer' %>
        </button>
        <a href="/blocks/<%= block.id %>/cards" class="btn btn-secondary">
          <img src="/icons/cancel.svg" alt="" class="btn-icon">
          Annuler
        </a>
      </div>
    </form>
  </div>

  <script>
    // Preview d'image en temps réel
    const mediaPathInput = document.getElementById('media_path');
    const imageUploadInput = document.getElementById('image_upload');

    if (mediaPathInput) {
      mediaPathInput.addEventListener('input', (e) => {
        updateImagePreview(e.target.value);
      });
    }

    function updateImagePreview(path) {
      if (!path) return;
      
      let existingPreview = document.querySelector('.image-preview');
      if (!existingPreview) {
        const formGroup = mediaPathInput.closest('.form-group');
        const previewDiv = document.createElement('div');
        previewDiv.className = 'form-group';
        previewDiv.innerHTML = `
          <label>Aperçu</label>
          <div class="image-preview">
            <img src="${path}" alt="Preview" style="max-width: 300px; border-radius: 8px;" onerror="this.style.display='none'">
          </div>
        `;
        formGroup.after(previewDiv);
      } else {
        const img = existingPreview.querySelector('img');
        if (img) {
          img.src = path;
          img.style.display = 'block';
        }
      }
    }

    // Gestion de l'upload d'image
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const statusEl = document.getElementById('upload_status');
      const pathInput = document.getElementById('media_path');

      // Validation taille client-side
      if (file.size > 5 * 1024 * 1024) {
        statusEl.textContent = "❌ Fichier trop volumineux (max 5 MB)";
        statusEl.style.color = "#e74c3c";
        event.target.value = "";
        return;
      }

      // Préparation FormData
      const formData = new FormData();
      formData.append("image", file);

      // Upload
      statusEl.textContent = "⏳ Upload en cours...";
      statusEl.style.color = "#3498db";

      try {
        const response = await fetch("/api/upload", {
          method: "POST",
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          statusEl.textContent = `✅ Image uploadée : ${result.filename}`;
          statusEl.style.color = "#27ae60";
          pathInput.value = result.path;
          updateImagePreview(result.path);
        } else {
          statusEl.textContent = `❌ Erreur : ${result.message}`;
          statusEl.style.color = "#e74c3c";
          event.target.value = "";
        }
      } catch (error) {
        statusEl.textContent = "❌ Erreur réseau lors de l'upload";
        statusEl.style.color = "#e74c3c";
        event.target.value = "";
      }
    }
  </script>
</body>
</html>
