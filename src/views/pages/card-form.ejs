<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css', '/css/buttons.css']
  })
%>
  <div class="admin-container">
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons: [
          { href: `/blocks/${block.id}/cards`, class: 'btn-secondary', icon: 'cancel', label: 'Annuler' }
        ]
      })
    %>

    <%- include('../partials/alerts') %>

    <form method="POST" action="<%= formAction %>" class="form-card">
      <div class="form-group">
        <label for="title">Titre de la carte *</label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          value="<%= card ? card.title : '' %>" 
          required
          placeholder="Titre de la carte"
        >
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea 
          id="description" 
          name="description" 
          rows="5"
          placeholder="Description détaillée de la carte"
        ><%= card ? card.description || '' : '' %></textarea>
      </div>

      <div class="form-group">
        <label for="media_path">Image de la carte</label>
        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
          <input 
            type="text" 
            id="media_path" 
            name="media_path" 
            value="<%= card ? card.media_path || '' : '' %>" 
            placeholder="/uploads/image.jpg ou /assets/placeholder-1.svg"
            style="flex: 1;"
          >
          <input 
            type="file" 
            id="media_path_upload" 
            accept="image/*"
            style="display: none;"
            data-target-field="media_path"
          >
          <button 
          <button 
            class="btn btn-secondary btn-sm"
            onclick="document.getElementById('media_path_upload').click()"
            title="Uploader une image"
          >
            <img src="/icons/image.svg" alt="" class="icon">
            Choisir
          </button>
        </div>
        <small class="form-help" id="media_path_status">
          Entrez un chemin (ex: /uploads/image.jpg) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.
        </small>
      </div>

      <!-- Preview de l'image -->
      <div class="form-group" id="media_path_preview_container" style="<%= card && card.media_path ? '' : 'display: none;' %>">
        <label>Aperçu de l'image</label>
        <div class="image-preview" id="media_path_preview">
          <% if (card && card.media_path) { %>
            <img src="<%= card.media_path %>" alt="<%= card.title %>" style="max-width: 300px; border-radius: 8px;">
          <% } else { %>
            <img src="" alt="Preview" style="max-width: 300px; border-radius: 8px;">
          <% } %>
        </div>
      </div>

      <% if (block.type === 'events') { %>
        <div class="form-group">
          <label for="event_date">Date de l'événement</label>
          <input 
            type="date" 
            id="event_date" 
            name="event_date" 
            value="<%= card && card.event_date ? new Date(card.event_date).toISOString().split('T')[0] : '' %>"
          >
          <small class="form-help">
            Date de l'événement pour les cartes du bloc "Événements".
          </small>
        </div>
      <% } %>

      <div class="form-group">
        <label for="position">Position *</label>
        <input 
          type="number" 
          id="position" 
          name="position" 
          value="<%= card ? card.position : 999 %>" 
          required
          min="1"
        >
        <small class="form-help">
          Ordre d'affichage (1 = premier).
        </small>
      </div>

      <div class="form-actions">
        <%- include('../components/icon-button', {
          type: 'submit',
          className: 'btn btn-primary',
          icon: 'save',
          text: card ? 'Mettre à jour' : 'Créer',
          ariaLabel: card ? 'Mettre à jour la carte' : 'Créer la carte'
        }) %>
        <%- include('../components/icon-button', {
          type: 'a',
          href: `/blocks/${block.id}/cards`,
          className: 'btn btn-secondary',
          icon: 'cancel',
          text: 'Annuler',
          ariaLabel: 'Annuler et retourner à la liste des cartes'
        }) %>
      </div>
    </form>
  </div>

<%- include('../partials/footer', { scripts: ['/js/image-upload.js'] }) %>
