<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css', '/css/buttons.css']
  })
%>
  <div class="admin-container">
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons: [
          { href: `/blocks/${block.id}/cards`, class: 'btn-secondary', icon: 'cancel', label: 'Annuler' }
        ]
      })
    %>

    <%- include('../partials/alerts') %>

    <%
      const isVideosBlock = block && block.type === 'videos';
      const mediaLabel = isVideosBlock ? 'URL de la vidéo YouTube' : 'Image de la carte';
      const mediaPlaceholder = isVideosBlock ? 'https://www.youtube.com/watch?v=...' : '/uploads/image.jpg ou /assets/placeholder-1.svg';
      const mediaHelpText = isVideosBlock ? 'Collez l\'URL complète de la vidéo YouTube (ex: https://www.youtube.com/watch?v=dQw4w9WgXcQ)' : 'Entrez un chemin (ex: /uploads/image.jpg) ou cliquez sur "Choisir" pour uploader. Formats: JPEG, PNG, WebP, GIF, SVG.';
      const currentTemplate = card ? card.template || 'default' : 'default';
    %>
    
    <form method="POST" action="<%= formAction %>" class="form-card">
      <!-- Sélection du template -->
      <div class="form-group">
        <label>Type de carte</label>
        <div class="template-selector">
          <% Object.values(CARD_TEMPLATES).forEach(template => { %>
            <label class="template-option <%= currentTemplate === template.id ? 'selected' : '' %>">
              <input 
                type="radio" 
                name="template" 
                value="<%= template.id %>" 
                <%= currentTemplate === template.id ? 'checked' : '' %>
              >
              <div class="template-card">
                <div class="template-icon">
                  <svg width="60" height="40" viewBox="0 0 60 40">
                    <% if (template.id === 'default') { %>
                      <rect x="5" y="5" width="50" height="20" fill="#ddd" rx="2"/>
                      <rect x="5" y="28" width="50" height="3" fill="#999" rx="1"/>
                      <rect x="5" y="33" width="40" height="2" fill="#ccc" rx="1"/>
                    <% } else if (template.id === 'image_left') { %>
                      <rect x="5" y="8" width="20" height="24" fill="#ddd" rx="2"/>
                      <rect x="28" y="10" width="27" height="3" fill="#999" rx="1"/>
                      <rect x="28" y="16" width="27" height="2" fill="#ccc" rx="1"/>
                      <rect x="28" y="20" width="20" height="2" fill="#ccc" rx="1"/>
                    <% } else if (template.id === 'image_right') { %>
                      <rect x="35" y="8" width="20" height="24" fill="#ddd" rx="2"/>
                      <rect x="5" y="10" width="27" height="3" fill="#999" rx="1"/>
                      <rect x="5" y="16" width="27" height="2" fill="#ccc" rx="1"/>
                      <rect x="5" y="20" width="20" height="2" fill="#ccc" rx="1"/>
                    <% } else if (template.id === 'photo') { %>
                      <rect x="5" y="5" width="50" height="28" fill="#ddd" rx="2"/>
                      <rect x="5" y="35" width="30" height="2" fill="#999" rx="1"/>
                    <% } else if (template.id === 'video') { %>
                      <rect x="5" y="8" width="50" height="22" fill="#ddd" rx="2"/>
                      <circle cx="30" cy="19" r="5" fill="#666"/>
                      <polygon points="28,17 28,21 32,19" fill="white"/>
                      <rect x="5" y="33" width="35" height="2" fill="#999" rx="1"/>
                    <% } else if (template.id === 'text_only') { %>
                      <rect x="5" y="10" width="50" height="4" fill="#999" rx="1"/>
                      <rect x="5" y="18" width="50" height="2" fill="#ccc" rx="1"/>
                      <rect x="5" y="22" width="45" height="2" fill="#ccc" rx="1"/>
                      <rect x="5" y="26" width="40" height="2" fill="#ccc" rx="1"/>
                    <% } %>
                  </svg>
                </div>
                <div class="template-name"><%= template.name %></div>
                <div class="template-description"><%= template.description %></div>
              </div>
            </label>
          <% }) %>
        </div>
      </div>

      <hr class="section-divider">

      <div class="form-group">
        <label for="title">Titre <span class="field-optional" data-template-field="title"></span></label>
        <input 
          type="text" 
          id="title" 
          name="title" 
          value="<%= card ? card.title : '' %>" 
          placeholder="Titre de la carte"
        >
      </div>

      <div class="form-group">
        <label for="description">Description (facultatif)</label>
        <textarea 
          id="description" 
          name="description" 
          rows="5"
          placeholder="Description de la carte"
        ><%= card ? card.description || '' : '' %></textarea>
      </div>

      <%- include('../components/color-picker', {
        name: 'description_bg_color',
        label: 'Couleur de fond de la description',
        value: card && card.description_bg_color ? card.description_bg_color : '#ffffff',
        helpText: 'Couleur de fond affichée derrière le texte de description.'
      }) %>

      <div class="form-group">
        <label for="media_path"><%= mediaLabel %></label>
        <div class="upload-field-row flex-start">
          <input 
            type="text" 
            id="media_path" 
            name="media_path" 
            value="<%= card ? card.media_path || '' : '' %>" 
            placeholder="<%= mediaPlaceholder %>"
            class="flex-1"
          >
          <% if (!isVideosBlock) { %>
            <input 
              type="file" 
              id="media_path_upload" 
              accept="image/*"
              class="upload-file-input"
              data-target-field="media_path"
            >
            <button 
              type="button"
              class="btn btn-secondary btn-sm"
              onclick="document.getElementById('media_path_upload').click()"
              title="Uploader une image"
            >
              <img src="/icons/image.svg" alt="" class="icon">
              Choisir
            </button>
          <% } %>
        </div>
        <small class="form-help" id="media_path_status">
          <%= mediaHelpText %>
        </small>
      </div>

      <!-- Preview de l'image -->
      <div class="form-group <%= card && card.media_path ? '' : 'd-none' %>" id="media_path_preview_container">
        <label>Aperçu de l'image</label>
        <div class="image-preview" id="media_path_preview">
          <% if (card && card.media_path) { %>
            <img src="<%= card.media_path %>" alt="<%= card.title %>" class="preview-img-responsive">
          <% } else { %>
            <img src="" alt="Preview" class="preview-img-responsive">
          <% } %>
        </div>
      </div>

      <% if (block.type === 'events') { %>
        <div class="form-group">
          <label for="event_date">Date de l'événement</label>
          <input 
            type="date" 
            id="event_date" 
            name="event_date" 
            value="<%= card && card.event_date ? new Date(card.event_date).toISOString().split('T')[0] : '' %>"
          >
          <small class="form-help">
            Date de l'événement pour les cartes du bloc "Événements".
          </small>
        </div>
      <% } %>

      <div class="form-group">
        <label for="position">Position *</label>
        <input 
          type="number" 
          id="position" 
          name="position" 
          value="<%= card ? card.position : 999 %>" 
          required
          min="1"
        >
        <small class="form-help">
          Ordre d'affichage (1 = premier).
        </small>
      </div>

      <div class="form-actions">
        <%- include('../components/icon-button', {
          type: 'submit',
          className: 'btn btn-primary',
          icon: 'save',
          text: card ? 'Mettre à jour' : 'Créer',
          ariaLabel: card ? 'Mettre à jour la carte' : 'Créer la carte'
        }) %>
        <%- include('../components/icon-button', {
          type: 'a',
          href: `/blocks/${block.id}/cards`,
          className: 'btn btn-secondary',
          icon: 'cancel',
          text: 'Annuler',
          ariaLabel: 'Annuler et retourner à la liste des cartes'
        }) %>
      </div>
    </form>
  </div>

  <script>
    // Gestion de la sélection de template
    document.querySelectorAll('.template-option').forEach(option => {
      option.addEventListener('click', function() {
        // Retirer la classe selected de tous
        document.querySelectorAll('.template-option').forEach(opt => opt.classList.remove('selected'));
        // Ajouter à celui cliqué
        this.classList.add('selected');
        // Cocher le radio
        this.querySelector('input[type="radio"]').checked = true;
        
        // Adapter le formulaire selon le template sélectionné
        updateFormFields(this.querySelector('input[type="radio"]').value);
      });
    });
    
    function updateFormFields(template) {
      const titleField = document.querySelector('[data-template-field="title"]');
      const descField = document.querySelector('[data-template-field="description"]');
      const mediaGroup = document.querySelector('#media_path').closest('.form-group');
      
      // Adapter les labels selon le template
      const templates = <%= JSON.stringify(CARD_TEMPLATES) %>;
      const selectedTemplate = templates[template];
      
      if (!selectedTemplate) return;
      
      // Masquer/afficher les champs selon le template
      const fields = selectedTemplate.fields || [];
      
      // Titre
      const titleRequired = fields.includes('title');
      if (titleField) {
        titleField.textContent = titleRequired ? '' : ' (facultatif)';
      }
      
      // Image/Média
      if (mediaGroup) {
        if (fields.includes('media_path')) {
          mediaGroup.style.display = '';
          const label = mediaGroup.querySelector('label');
          if (template === 'video') {
            label.textContent = 'URL de la vidéo ou fichier';
          } else if (template === 'photo') {
            label.textContent = 'Photo';
          } else {
            label.textContent = 'Image';
          }
        } else {
          mediaGroup.style.display = 'none';
        }
      }
    }
    
    // Initialiser au chargement
    const selectedTemplate = document.querySelector('.template-option.selected input[type="radio"]');
    if (selectedTemplate) {
      updateFormFields(selectedTemplate.value);
    }
  </script>

<%- include('../partials/footer', { scripts: ['/js/image-upload.js'] }) %>
