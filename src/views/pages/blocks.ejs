<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css']
  })
%>
  <div class="admin-container">
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons: [
          { href: '/blocks/new', class: 'btn-primary', icon: 'plus', label: 'Nouveau bloc' },
          { href: '/admins', class: 'btn-secondary', icon: 'user', label: 'Admins' }
        ]
      })
    %>

    <%- include('../partials/alerts') %>

    <% if (blocks && blocks.length > 0) { %>
      <table role="table" aria-label="Liste des blocs du site">
        <caption class="sr-only">Gestion des blocs (header, sections, footer) avec possibilité de réordonnancement</caption>
        <thead>
          <tr>
            <th scope="col">Position</th>
            <th scope="col">Type</th>
            <th scope="col">Titre</th>
            <th scope="col">Slug</th>
            <th scope="col">Statut</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody id="blocks-list">
          <% blocks.forEach(block => { %>
            <tr data-block-id="<%= block.id %>" data-position="<%= block.position %>" data-block-type="<%= block.type %>">
              <td class="block-position">
                <span class="position-value"><%= block.position %></span>
                <% if (block.type !== 'header' && block.type !== 'footer') { %>
                  <div class="position-controls">
                    <button 
                      class="btn-move-up" 
                      title="Monter"
                      aria-label="Monter le bloc <%= block.title %>"
                    >
                      <img src="/icons/arrow-up.svg" alt="">
                    </button>
                    <button 
                      class="btn-move-down" 
                      title="Descendre"
                      aria-label="Descendre le bloc <%= block.title %>"
                    >
                      <img src="/icons/arrow-down.svg" alt="">
                    </button>
                  </div>
                <% } else { %>
                  <span class="text-muted" style="font-size: 0.85rem;">
                    <%= block.type === 'header' ? 'Toujours en premier' : 'Toujours en dernier' %>
                  </span>
                <% } %>
              </td>
              <td>
                <span class="badge badge-type-<%= block.type %>">
                  <%= block.type %>
                </span>
              </td>
              <td><%= block.title %></td>
              <td><code><%= block.slug %></code></td>
              <td>
                <% if (block.is_locked) { %>
                  <span class="badge badge-locked">Verrouillé</span>
                <% } else { %>
                  <span class="badge badge-unlocked">Modifiable</span>
                <% } %>
              </td>
              <td>
                <div class="actions" role="group" aria-label="Actions pour le bloc <%= block.title %>">
                  <a 
                    href="/blocks/<%= block.id %>/cards" 
                    class="btn btn-secondary btn-sm"
                    aria-label="Gérer les cartes du bloc <%= block.title %>"
                  >
                    <img src="/icons/image.svg" alt="" role="presentation" class="btn-icon">
                  </a>
                  <a 
                    href="/blocks/<%= block.id %>/edit" 
                    class="btn btn-secondary btn-sm"
                    aria-label="Modifier le bloc <%= block.title %>"
                  >
                    <img src="/icons/edit.svg" alt="" role="presentation" class="btn-icon">
                  </a>
                  <% if (!block.is_locked) { %>
                    <form 
                      method="POST" 
                      action="/blocks/<%= block.id %>/delete" 
                      style="display: inline;"
                      onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer ce bloc ?');"
                      aria-label="Formulaire de suppression"
                    >
                      <button 
                        type="submit" 
                        class="btn btn-danger btn-sm"
                        aria-label="Supprimer le bloc <%= block.title %>"
                      >
                        <img src="/icons/trash.svg" alt="" role="presentation" class="btn-icon">
                      </button>
                    </form>
                  <% } %>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <p>Aucun bloc pour le moment.</p>
        <a href="/blocks/new" class="btn btn-primary">
          <img src="/icons/plus.svg" alt="" class="btn-icon">
          Créer le premier bloc
        </a>
      </div>
    <% } %>
  </div>

  <script>
    // Réordonnancement des blocs
    document.addEventListener('DOMContentLoaded', () => {
      const blocksList = document.getElementById('blocks-list');
      if (!blocksList) return;

      const rows = Array.from(blocksList.querySelectorAll('tr'));

      // Fonction pour échanger deux lignes
      function swapRows(index1, index2) {
        if (index2 < 0 || index2 >= rows.length) return;
        
        const row1 = rows[index1];
        const row2 = rows[index2];
        
        // Empêcher de déplacer ou échanger avec le header ou le footer
        const type1 = row1.getAttribute('data-block-type');
        const type2 = row2.getAttribute('data-block-type');
        const isFixed1 = type1 === 'header' || type1 === 'footer';
        const isFixed2 = type2 === 'header' || type2 === 'footer';
        
        if (isFixed1 || isFixed2) {
          console.log('Le header et le footer ne peuvent pas être déplacés');
          return;
        }
        
        if (index1 < index2) {
          row2.parentNode.insertBefore(row1, row2.nextSibling);
        } else {
          row1.parentNode.insertBefore(row2, row1);
        }
        
        // Inverser dans le tableau local
        [rows[index1], rows[index2]] = [rows[index2], rows[index1]];
        
        // Mettre à jour les positions visuelles
        updatePositions();
        
        // Envoyer au serveur
        saveOrder();
      }

      // Mettre à jour les numéros de position affichés
      function updatePositions() {
        rows.forEach((row, index) => {
          const positionSpan = row.querySelector('.position-value');
          if (positionSpan) {
            positionSpan.textContent = index + 1;
          }
          row.setAttribute('data-position', index + 1);
        });
      }

      // Enregistrer l'ordre sur le serveur
      function saveOrder() {
        // Ne pas inclure header et footer dans l'ordre envoyé (gérés par le backend)
        const order = rows
          .filter(row => {
            const type = row.getAttribute('data-block-type');
            return type !== 'header' && type !== 'footer';
          })
          .map((row, index) => ({
            id: parseInt(row.getAttribute('data-block-id'), 10),
            position: index + 1
          }));

        fetch('/api/blocks/reorder', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order })
        })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            console.error('Erreur lors de la sauvegarde:', data.error);
            alert('Erreur lors de la sauvegarde de l\'ordre');
          }
        })
        .catch(error => {
          console.error('Erreur réseau:', error);
          alert('Erreur réseau lors de la sauvegarde');
        });
      }

      // Attacher les événements aux boutons
      rows.forEach((row, index) => {
        const btnUp = row.querySelector('.btn-move-up');
        const btnDown = row.querySelector('.btn-move-down');

        if (btnUp) {
          btnUp.addEventListener('click', () => swapRows(index, index - 1));
        }

        if (btnDown) {
          btnDown.addEventListener('click', () => swapRows(index, index + 1));
        }
      });
    });
  </script>
<%- include('../partials/footer') %>
