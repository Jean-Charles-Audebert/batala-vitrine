<%-
  include('../partials/head', {
    title,
    subtitle: 'Batala Vitrine',
    stylesheets: ['/css/admin.css']
  })
%>
  <div class="admin-container">
    <%-
      include('../partials/admin-toolbar', {
        title,
        toolbarButtons: [
          { href: `/blocks/${block.id}/cards/new`, class: 'btn-primary', icon: 'plus', label: 'Nouvelle carte' },
          { href: '/blocks', class: 'btn-secondary', icon: 'arrow-up', label: 'Retour aux blocs' }
        ]
      })
    %>

    <%- include('../partials/alerts') %>

    <% if (cards && cards.length > 0) { %>
      <table>
        <thead>
          <tr>
            <th>Position</th>
            <th>Titre</th>
            <th>Description</th>
            <th>Image</th>
            <% if (block.type === 'events') { %>
              <th>Date événement</th>
            <% } %>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="cards-list">
          <% cards.forEach(card => { %>
            <tr data-card-id="<%= card.id %>" data-position="<%= card.position %>">
              <td class="card-position">
                <span class="position-value"><%= card.position %></span>
                <div class="position-controls">
                  <button 
                    class="btn-move-up" 
                    title="Monter"
                    aria-label="Monter la carte <%= card.title %>"
                  >
                    <img src="/icons/arrow-up.svg" alt="">
                  </button>
                  <button 
                    class="btn-move-down" 
                    title="Descendre"
                    aria-label="Descendre la carte <%= card.title %>"
                  >
                    <img src="/icons/arrow-down.svg" alt="">
                  </button>
                </div>
              </td>
              <td><strong><%= card.title %></strong></td>
              <td>
                <% if (card.description) { %>
                  <%= card.description.substring(0, 100) %><%= card.description.length > 100 ? '...' : '' %>
                <% } else { %>
                  <em class="text-muted">Pas de description</em>
                <% } %>
              </td>
              <td>
                <% if (card.media_path) { %>
                  <img src="<%= card.media_path %>" alt="<%= card.title %>" class="card-thumbnail">
                <% } else { %>
                  <span class="text-muted">Pas d'image</span>
                <% } %>
              </td>
              <% if (block.type === 'events') { %>
                <td>
                  <% if (card.event_date) { %>
                    <%= new Date(card.event_date).toLocaleDateString('fr-FR') %>
                  <% } else { %>
                    <span class="text-muted">-</span>
                  <% } %>
                </td>
              <% } %>
              <td>
                <div class="actions">
                  <a 
                    href="/blocks/<%= block.id %>/cards/<%= card.id %>/edit" 
                    class="btn btn-secondary btn-sm"
                    title="Modifier"
                  >
                    <img src="/icons/edit.svg" alt="" class="btn-icon">
                  </a>
                  <form 
                    method="POST" 
                    action="/blocks/<%= block.id %>/cards/<%= card.id %>/delete" 
                    style="display: inline;"
                    onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette carte ?');"
                  >
                    <button 
                      type="submit" 
                      class="btn btn-danger btn-sm"
                      title="Supprimer"
                    >
                      <img src="/icons/trash.svg" alt="" class="btn-icon">
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    <% } else { %>
      <div class="empty-state">
        <p>Aucune carte pour ce bloc.</p>
        <a href="/blocks/<%= block.id %>/cards/new" class="btn btn-primary">
          <img src="/icons/plus.svg" alt="" class="btn-icon">
          Créer la première carte
        </a>
      </div>
    <% } %>
  </div>

  <script>
    // Réordonnancement des cartes
    document.addEventListener('DOMContentLoaded', () => {
      const cardsList = document.getElementById('cards-list');
      if (!cardsList) return;

      const rows = Array.from(cardsList.querySelectorAll('tr'));

      function swapRows(index1, index2) {
        if (index2 < 0 || index2 >= rows.length) return;
        
        const row1 = rows[index1];
        const row2 = rows[index2];
        
        if (index1 < index2) {
          row2.parentNode.insertBefore(row1, row2.nextSibling);
        } else {
          row1.parentNode.insertBefore(row2, row1);
        }
        
        [rows[index1], rows[index2]] = [rows[index2], rows[index1]];
        updatePositions();
        saveOrder();
      }

      function updatePositions() {
        rows.forEach((row, index) => {
          const positionSpan = row.querySelector('.position-value');
          if (positionSpan) {
            positionSpan.textContent = index + 1;
          }
          row.setAttribute('data-position', index + 1);
        });
      }

      function saveOrder() {
        const blockId = '<%= block.id %>';
        const order = rows.map((row, index) => ({
          id: parseInt(row.getAttribute('data-card-id'), 10),
          position: index + 1
        }));

        fetch(`/api/blocks/${blockId}/cards/reorder`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ order })
        })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            console.error('Erreur lors de la sauvegarde:', data.error);
            alert('Erreur lors de la sauvegarde de l\'ordre');
          }
        })
        .catch(error => {
          console.error('Erreur réseau:', error);
          alert('Erreur réseau lors de la sauvegarde');
        });
      }

      rows.forEach((row, index) => {
        const btnUp = row.querySelector('.btn-move-up');
        const btnDown = row.querySelector('.btn-move-down');

        if (btnUp) {
          btnUp.addEventListener('click', () => swapRows(index, index - 1));
        }

        if (btnDown) {
          btnDown.addEventListener('click', () => swapRows(index, index + 1));
        }
      });
    });
  </script>
<%- include('../partials/footer') %>
