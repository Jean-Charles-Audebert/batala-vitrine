<%
  /**
   * Composant: Section Card Grid
   * Grille de cards (événements, services, etc.)
   */
  const {
    id,
    title: sectionTitle,
    layout = 'grid_3',
    bg_color,
    bg_image,
    bg_video,
    bg_youtube,
    is_transparent,
    padding_top = 'medium',
    padding_bottom = 'medium',
    cards = [],
    decorations = []
  } = section;
  
  const bgStyle = [];
  if (bg_color && !is_transparent) bgStyle.push(`background-color: ${bg_color}`);
  if (bg_image) bgStyle.push(`background-image: url(${bg_image})`);
  
  const sectionClasses = [
    'section',
    'section-card-grid',
    `section-card-grid--${layout}`,
    `padding-top-${padding_top}`,
    `padding-bottom-${padding_bottom}`
  ];
  if (is_transparent) sectionClasses.push('section-transparent');
%>

<section 
  class="<%= sectionClasses.join(' ') %>"
  data-section-id="<%= id %>"
  <% if (bgStyle.length > 0) { %>style="<%= bgStyle.join('; ') %>"<% } %>
>
  <% if (bg_youtube) { %>
  <% 
    let videoId = '';
    try {
      if (bg_youtube.includes('youtu.be/')) {
        videoId = bg_youtube.split('youtu.be/')[1].split('?')[0].split('&')[0];
      } else if (bg_youtube.includes('youtube.com/watch')) {
        const url = new URL(bg_youtube);
        videoId = url.searchParams.get('v');
      } else if (bg_youtube.includes('youtube.com/embed/')) {
        videoId = bg_youtube.split('embed/')[1].split('?')[0].split('&')[0];
      } else if (bg_youtube.includes('youtube.com/shorts/')) {
        videoId = bg_youtube.split('shorts/')[1].split('?')[0].split('&')[0];
      }
    } catch (e) {
      console.error('Erreur extraction ID YouTube:', e);
    }
  %>
  <% if (videoId) { %>
  <iframe 
    class="section-bg-youtube" 
    src="https://www.youtube.com/embed/<%= videoId %>?autoplay=1&mute=1&loop=1&playlist=<%= videoId %>&controls=0&rel=0&modestbranding=1&playsinline=1"
    frameborder="0" 
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
    referrerpolicy="strict-origin-when-cross-origin"
    allowfullscreen
    style="pointer-events: none;">
  </iframe>
  <% } %>
  <% } else if (bg_video) { %>
  <video class="section-bg-video" autoplay muted loop playsinline>
    <source src="<%= bg_video %>" type="video/mp4">
  </video>
  <% } %>

  <% if (decorations && decorations.length > 0) { %>
    <% decorations.forEach(deco => { %>
      <%- include('../decorations/renderer', { decoration: deco }) %>
    <% }) %>
  <% } %>
  
  <div class="container">
    <% if (sectionTitle) { %>
      <h2 class="section-title"><%= sectionTitle %></h2>
    <% } %>
    
    <div class="cards-grid cards-grid--<%= layout.replace('grid_', '') %>">
      <% if (cards && cards.length > 0) { %>
        <% cards.forEach(card => { %>
          <article class="card" data-card-id="<%= card.id %>">
            <% if (card.media_url) { %>
              <div class="card-media">
                <% if (card.media_type === 'youtube') { %>
                  <div class="video-wrapper">
                    <iframe 
                      src="<%= card.media_url.replace('watch?v=', 'embed/').replace('youtu.be/', 'youtube.com/embed/') %>" 
                      frameborder="0" 
                      allowfullscreen
                    ></iframe>
                  </div>
                <% } else { %>
                  <img src="<%= card.media_url %>" alt="<%= card.title || '' %>">
                <% } %>
              </div>
            <% } %>
            
            <div class="card-content">
              <% if (card.title) { %>
                <h3><%= card.title %></h3>
              <% } %>
              <% if (card.description) { %>
                <p><%= card.description %></p>
              <% } %>
              <% if (card.event_date) { %>
                <time datetime="<%= new Date(card.event_date).toISOString() %>">
                  <%= new Date(card.event_date).toLocaleDateString('fr-FR') %>
                </time>
              <% } %>
              <% if (card.link_url) { %>
                <a href="<%= card.link_url %>" class="card-link">En savoir plus</a>
              <% } %>
            </div>
            
            <% if (typeof user !== 'undefined' && user) { %>
              <div class="card-actions">
                <button class="edit-btn" data-card-id="<%= card.id %>" data-section-id="<%= id %>" data-action="edit-card"><img src="/icons/edit.svg" alt="" class="icon"></button>
                <button class="delete-btn" data-card-id="<%= card.id %>" data-section-id="<%= id %>" data-action="delete-card"><img src="/icons/trash.svg" alt="" class="icon"></button>
              </div>
            <% } %>
          </article>
        <% }) %>
      <% } else { %>
        <p class="empty-state">Aucune card à afficher</p>
      <% } %>
    </div>
    
    <% if (typeof user !== 'undefined' && user) { %>
      <button class="btn-add-card" data-section-id="<%= id %>" data-action="add-card">
        + Ajouter une card
      </button>
    <% } %>
  </div>
  
  <% if (typeof user !== 'undefined' && user) { %>
    <div class="edit-controls">
      <button 
        class="edit-btn" 
        data-section-id="<%= id %>"
        data-action="edit-section"
        aria-label="Paramètres section"
        title="Paramètres (fond, layout)"
      >
        <img src="/icons/settings.svg" alt="" class="icon">
      </button>
    </div>
  <% } %>
</section>