<%
  // Composant Media Gallery (Photos / Vidéos)
  // Variables attendues: contentBlock, user
  const bgStyle = contentBlock.bg_image ? `background-image: url(${contentBlock.bg_image})` : '';
  const isPhotos = contentBlock.type === 'photos';
  const isVideos = contentBlock.type === 'videos';
  const sectionLabel = isPhotos ? 'Galerie de photos' : 'Galerie de vidéos';
  const addButtonLabel = isPhotos ? 'Ajouter une photo' : 'Ajouter une vidéo';
%>

<section 
  class="block-section" 
  id="<%= contentBlock.slug %>" 
  data-block-id="<%= contentBlock.id %>"
  data-transparent="<%= contentBlock.is_transparent ? 'true' : 'false' %>"
  <% if (contentBlock.bg_color) { %>
  style="background-color: <%= contentBlock.bg_color %>; <%= bgStyle %>"
  <% } else { %>
  style="<%= bgStyle %>"
  <% } %>
  aria-labelledby="section-title-<%= contentBlock.id %>"
>
  <div class="container">
    <% if (contentBlock.title) { %>
      <div class="section-header">
        <h2 
          class="section-title"
          id="section-title-<%= contentBlock.id %>"
          <% if (contentBlock.title_font || contentBlock.title_color) { %>
          style="<%= contentBlock.title_font ? `font-family: ${contentBlock.title_font};` : '' %> <%= contentBlock.title_color ? `color: ${contentBlock.title_color};` : '' %>"
          <% } %>
        ><%= contentBlock.title %></h2>
        <% if (user) { %>
          <%-
            include('icon-button', {
              type: 'button',
              className: 'add-card-btn',
              icon: 'plus',
              ariaLabel: addButtonLabel,
              dataAttrs: { 'data-block-id': contentBlock.id }
            })
          %>
        <% } %>
      </div>
    <% } else if (user) { %>
      <div class="section-header" style="justify-content: flex-end;">
        <%-
          include('icon-button', {
            type: 'button',
            className: 'add-card-btn',
            icon: 'plus',
            ariaLabel: addButtonLabel,
            dataAttrs: { 'data-block-id': contentBlock.id }
          })
        %>
      </div>
    <% } %>
    
    <% if (contentBlock.cards && contentBlock.cards.length > 0) { %>
      <div class="cards-grid" role="list" aria-label="<%= sectionLabel %>">
        <% contentBlock.cards.forEach(card => { %>
          <% 
            // Styles de la carte
            const cardStyles = [];
            if (card.bg_color) cardStyles.push(`background-color: ${card.bg_color}`);
            const cardStyleAttr = cardStyles.length > 0 ? `style="${cardStyles.join('; ')}"` : '';
            
            // Pour les vidéos YouTube, extraire l'ID et construire l'URL du thumbnail
            let mediaUrl = card.media_path;
            let youtubeId = null;
            if (isVideos && card.media_path) {
              // Extraire l'ID YouTube depuis différents formats d'URL
              const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\s?]+)/,
              ];
              for (const pattern of patterns) {
                const match = card.media_path.match(pattern);
                if (match) {
                  youtubeId = match[1];
                  mediaUrl = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
                  break;
                }
              }
            }
          %>
          
          <% 
            // BDD stocke la version optimisée par défaut, on dérive l'originale pour le lien plein écran
            const targetUrl = isPhotos ? getOriginalPath(card.media_path) : (youtubeId ? `https://www.youtube.com/watch?v=${youtubeId}` : null);
            const targetLabel = isPhotos ? 'Voir la photo en plein écran' : `Regarder la vidéo ${card.title || ''}`;
            // Pour les photos, afficher la version optimisée (stockée en BDD)
            const thumbnailUrl = card.media_path;
          %>
          
          <% if (targetUrl) { %>
            <div class="card card-wrapper" role="listitem" data-card-id="<%= card.id %>" <%- cardStyleAttr %>>
              <a 
                href="<%= targetUrl %>" 
                target="_blank" 
                rel="noopener noreferrer" 
                class="card-link" 
                aria-label="<%= targetLabel %>"
              >
                <% if (isPhotos && card.media_path) { %>
                  <!-- Photo : vignette optimisée, lien vers original pleine résolution -->
                  <img src="<%= thumbnailUrl %>" alt="<%= card.title || 'Photo' %>" loading="lazy">
                <% } else if (isVideos && youtubeId) { %>
                  <!-- Vidéo YouTube -->
                  <img src="<%= mediaUrl %>" alt="<%= card.title || 'Vidéo' %>" loading="lazy">
                  <div class="video-overlay">
                    <svg width="68" height="48" viewBox="0 0 68 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="#f00"/>
                      <path d="M45 24 27 14v20" fill="#fff"/>
                    </svg>
                  </div>
                <% } %>
                
                <% if (card.title || card.description) { %>
                  <div class="card-content">
                    <% if (card.title) { %>
                      <h3 
                        class="card-title"
                        <% if (card.title_color) { %>
                        style="color: <%= card.title_color %>;"
                        <% } %>
                      ><%= card.title %></h3>
                    <% } %>
                    <% if (card.description) { %>
                      <% 
                        const descStyles = [];
                        if (card.description_color) descStyles.push(`color: ${card.description_color}`);
                        if (card.description_bg_color) descStyles.push(`background-color: ${card.description_bg_color}`, 'padding: 0.75rem', 'border-radius: 4px');
                        const descStyleAttr = descStyles.length > 0 ? `style="${descStyles.join('; ')}"` : '';
                      %>
                      <p class="card-description" <%- descStyleAttr %>><%= card.description %></p>
                    <% } %>
                  </div>
                <% } %>
              </a>
              
              <% if (user) { %>
                <div class="card-actions">
                  <%-
                    include('icon-button', {
                      type: 'a',
                      href: `/blocks/${contentBlock.id}/cards/${card.id}/edit`,
                      className: 'btn-secondary',
                      icon: 'edit',
                      text: '',
                      ariaLabel: `Modifier ${isPhotos ? 'la photo' : 'la vidéo'}`,
                      dataAttrs: {}
                    })
                  %>
                  <%-
                    include('icon-button', {
                      type: 'button',
                      className: 'btn-danger delete-card-btn',
                      icon: 'trash',
                      text: '',
                      ariaLabel: `Supprimer ${isPhotos ? 'la photo' : 'la vidéo'}`,
                      dataAttrs: { 
                        'data-card-id': card.id,
                        'data-block-id': contentBlock.id
                      }
                    })
                  %>
                </div>
              <% } %>
            </div>
          <% } else { %>
            <div class="card" role="listitem" data-card-id="<%= card.id %>" <%- cardStyleAttr %>>
              <p class="card-error">Média non disponible</p>
            </div>
          <% } %>
        <% }); %>
      </div>
    <% } else { %>
      <div class="empty-state">
        <p>Aucun <%= isPhotos ? 'photo' : 'vidéo' %> pour le moment.</p>
        <% if (user) { %>
          <p class="empty-cta">Cliquez sur le bouton <strong>+</strong> pour en ajouter.</p>
        <% } %>
      </div>
    <% } %>
  </div>
</section>

<style>
  /* Wrapper de carte pour photos/vidéos */
  .card-wrapper {
    position: relative;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card-wrapper:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
  }
  
  /* Lien cliquable couvrant toute la carte */
  .card-link {
    display: block;
    text-decoration: none;
    color: inherit;
    cursor: pointer;
  }
  
  .card-link img {
    display: block;
    width: 100%;
    height: auto;
  }
  
  /* Overlay pour les vidéos YouTube */
  .video-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.9;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }
  
  .card-wrapper:hover .video-overlay {
    opacity: 1;
  }
  
  /* Actions admin en dehors du lien */
  .card-wrapper .card-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
    display: flex;
    gap: 0.5rem;
  }
  
  .card-wrapper .card-actions a,
  .card-wrapper .card-actions button {
    pointer-events: auto;
    background: white;
    padding: 0.5rem;
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .card-wrapper .card-actions a:hover,
  .card-wrapper .card-actions button:hover {
    background: #f0f0f0;
  }
</style>
