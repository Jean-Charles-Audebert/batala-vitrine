<%
  // Composant Footer
  // Variables attendues: contentBlock, user, getSocialIcon
  // Les éléments ont maintenant parsedContent au lieu de content brut
  const aboutElement = contentBlock.elements.find(el => el.type === 'text');
  const contactElement = contentBlock.elements.find(el => el.type === 'contact');
  const socialElements = contentBlock.elements.filter(el => el.type === 'social');
  const linkElements = contentBlock.elements.filter(el => el.type === 'link');
  
  const aboutData = aboutElement?.parsedContent || null;
  const contactData = contactElement?.parsedContent || null;
  
  // Agréger tous les liens sociaux
  const allSocialLinks = [];
  socialElements.forEach(el => {
    if (el.parsedContent && el.parsedContent.links) {
      allSocialLinks.push(...el.parsedContent.links);
    }
  });
  
  // Agréger tous les liens externes
  const allExternalLinks = [];
  linkElements.forEach(el => {
    if (el.parsedContent) {
      allExternalLinks.push({
        id: el.id,
        label: el.parsedContent.label || el.parsedContent.title,
        url: el.parsedContent.url
      });
    }
  });
%>

<footer class="block-section footer-section" data-block-id="<%= contentBlock.id %>" role="contentinfo">
  <div class="container">
    <div class="footer-content">
      <div class="footer-column">
        <details>
          <summary>À propos</summary>
          <div role="region" aria-label="Informations sur l'organisation">
            <% if (aboutData && aboutData.about_content) { %>
              <p><%= aboutData.about_content %></p>
            <% } else { %>
              <p>Description de votre organisation</p>
            <% } %>
            <% if (user) { %>
              <%-
                include('icon-button', {
                  type: 'button',
                  className: 'edit-footer-section-btn',
                  icon: 'edit',
                  ariaLabel: 'Modifier la section À propos',
                  dataAttrs: {
                    'data-block-id': contentBlock.id,
                    'data-element-id': aboutElement ? aboutElement.id : '',
                    'data-section': 'about'
                  }
                })
              %>
            <% } %>
          </div>
        </details>
      </div>
      
      <div class="footer-column">
        <details>
          <summary>Contact</summary>
          <div role="region" aria-label="Formulaire de contact">
            <form id="contact-form" class="contact-form">
              <div class="form-group-inline">
                <input 
                  type="text" 
                  id="contact-nom" 
                  name="nom" 
                  placeholder="Nom *" 
                  required
                  aria-label="Votre nom"
                >
              </div>
              <div class="form-group-inline">
                <input 
                  type="text" 
                  id="contact-prenom" 
                  name="prenom" 
                  placeholder="Prénom *" 
                  required
                  aria-label="Votre prénom"
                >
              </div>
              <div class="form-group-inline">
                <input 
                  type="text" 
                  id="contact-contact" 
                  name="contact" 
                  placeholder="Email ou Téléphone *" 
                  required
                  aria-label="Votre email ou téléphone"
                >
              </div>
              <div class="form-group-inline">
                <textarea 
                  id="contact-message" 
                  name="message" 
                  rows="3" 
                  placeholder="Votre message *" 
                  required
                  aria-label="Votre message"
                ></textarea>
              </div>
              <button type="submit" class="btn-submit-contact">Envoyer</button>
              <div id="contact-form-status" class="contact-status"></div>
            </form>
          </div>
        </details>
      </div>
      
      <div class="footer-column">
        <details>
          <summary>Suivez-nous</summary>
          <nav class="social-links" aria-label="Réseaux sociaux">
            <% if (allSocialLinks && allSocialLinks.length > 0) { %>
              <% allSocialLinks.forEach(link => { %>
                <a 
                  href="<%= link.url %>" 
                  class="social-link"
                  target="_blank" 
                  rel="noopener noreferrer"
                  aria-label="<%= link.platform || link.network %> (ouvre dans un nouvel onglet)"
                >
                  <%- getSocialIcon(link.platform || link.network) %>
                </a>
              <% }) %>
            <% } else { %>
              <p class="text-muted">Aucun réseau social configuré.</p>
            <% } %>
            <% if (user) { %>
              <%-
                include('icon-button', {
                  type: 'button',
                  className: 'edit-footer-section-btn',
                  icon: 'edit',
                  ariaLabel: 'Gérer les réseaux sociaux',
                  dataAttrs: {
                    'data-block-id': contentBlock.id,
                    'data-section': 'social'
                  }
                })
              %>
            <% } %>
          </nav>
        </details>
      </div>
      
      <div class="footer-column">
        <details>
          <summary>Liens utiles</summary>
          <nav class="external-links" aria-label="Liens externes">
            <% if (allExternalLinks && allExternalLinks.length > 0) { %>
              <ul class="links-list">
                <% allExternalLinks.forEach(link => { %>
                  <li>
                    <a 
                      href="<%= link.url %>" 
                      target="_blank" 
                      rel="noopener noreferrer"
                      aria-label="<%= link.label %> (ouvre dans un nouvel onglet)"
                    >
                      <%= link.label %>
                    </a>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <p class="text-muted">Aucun lien externe.</p>
            <% } %>
            <% if (user) { %>
              <%-
                include('icon-button', {
                  type: 'button',
                  className: 'edit-footer-section-btn',
                  icon: 'edit',
                  ariaLabel: 'Gérer les liens externes',
                  dataAttrs: {
                    'data-block-id': contentBlock.id,
                    'data-section': 'link'
                  }
                })
              %>
            <% } %>
          </nav>
        </details>
      </div>
    </div>
    
    <div class="footer-bottom">
      <p>&copy; 2025 <a href="https://caixadev.dev" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline;">caixaDev</a>. Tous droits réservés.</p>
    </div>
  </div>
</footer>
